<h3><span style="background-color:yellow;">Question</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">ID-1919096</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">:</span> </h3><h2><span style="background-color:yellow;">Mass</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">replace</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">python</span> ? </h2><p><span style="background-color:yellow;">Say</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">looks</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>str = "The &yquick &cbrown &bfox &Yjumps over the &ulazy dog"
</code></pre>
<p><span style="background-color:yellow;">You</span> <span style="background-color:yellow;">'ll</span> <span style="background-color:yellow;">notice</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">lot</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">locations</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">where</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">ampersand</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">followed</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">character</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">such</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">&amp</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">y</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">&amp</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">c</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;"></span> . <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">need</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">replace</span> <span style="background-color:yellow;">these</span> <span style="background-color:yellow;">characters</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">appropriate</span> <span style="background-color:yellow;">value</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>dict = {"&y":"\033[0;30m",
        "&c":"\033[0;31m",
        "&b":"\033[0;32m",
        "&Y":"\033[0;33m",
        "&u":"\033[0;34m"}
</code></pre>
<p><span style="background-color:yellow;">What</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">fastest</span> <span style="background-color:yellow;">way</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">this</span> ? <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">manually</span> <span style="background-color:yellow;">find</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">ampersands</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">then</span> <span style="background-color:yellow;">loop</span> <span style="background-color:yellow;">through</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">change</span> <span style="background-color:yellow;">them</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">seems</span> <span style="background-color:yellow;">slow.</span> <span style="background-color:yellow;">Doing</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">bunch</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">regex</span> <span style="background-color:yellow;">replaces</span> <span style="background-color:yellow;">seems</span> <span style="background-color:yellow;">slow</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">well</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">about</span> <span style="background-color:yellow;">30-40</span> <span style="background-color:yellow;">pairs</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">actual</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;"></span> . </p>
<p><span style="background-color:yellow;">Any</span> <span style="background-color:yellow;">suggestions</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">appreciated</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">thanks</span> . </p>
<p><span style="background-color:yellow;">Edit</span> <span style="background-color:yellow;">:</span> </p>
<p><span style="background-color:yellow;">As</span> <span style="background-color:yellow;">has</span> <span style="background-color:yellow;">been</span> <span style="background-color:yellow;">pointed</span> <span style="background-color:yellow;">out</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">comments</span> <span style="background-color:yellow;">throught</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">question</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">defined</span> <span style="background-color:yellow;">before</span> <span style="background-color:yellow;">runtime</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">never</span> <span style="background-color:yellow;">change</span> <span style="background-color:yellow;">during</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">course</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">applications</span> <span style="background-color:yellow;">life</span> <span style="background-color:yellow;">cycle.</span> <span style="background-color:yellow;">It</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">list</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">ANSI</span> <span style="background-color:yellow;">escape</span> <span style="background-color:yellow;">sequences</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">about</span> <span style="background-color:yellow;">40</span> <span style="background-color:yellow;">items</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">it.</span> <span style="background-color:yellow;">My</span> <span style="background-color:yellow;">average</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">length</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">compare</span> <span style="background-color:yellow;">against</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">about</span> <span style="background-color:yellow;">500</span> <span style="background-color:yellow;">characters</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">ones</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">up</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">5000</span> <span style="background-color:yellow;">characters</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">although</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">these</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">rare</span> <span style="background-color:yellow;"></span> . <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">am</span> <span style="background-color:yellow;">also</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">2.6</span> <span style="background-color:yellow;">currently</span> . </p>
<p><span style="background-color:yellow;">Edit</span> <span style="background-color:yellow;">#</span> <span style="background-color:yellow;">2</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">accepted</span> <span style="background-color:yellow;">Tor</span> <span style="background-color:yellow;">Valamos</span> <span style="background-color:yellow;">answer</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">correct</span> <span style="background-color:yellow;">one</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">only</span> <span style="background-color:yellow;">gave</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">valid</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">although</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">was</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">best</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">took</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">others</span> <span style="background-color:yellow;">into</span> <span style="background-color:yellow;">account</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">did</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">tremendous</span> <span style="background-color:yellow;">amount</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">work</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">compare</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">them.</span> <span style="background-color:yellow;">That</span> <span style="background-color:yellow;">answer</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">one</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">best</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">most</span> <span style="background-color:yellow;">helpful</span> <span style="background-color:yellow;">answers</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">ever</span> <span style="background-color:yellow;">come</span> <span style="background-color:yellow;">across</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">StackOverflow.</span> <span style="background-color:yellow;">Kudos</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">you</span> . </p>
<br /><h3><span style="background-color:yellow;">Answers</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">Total-12</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">:</span> </h3><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">0</span> </b><br /><pre><code>mydict = {"&y":"\033[0;30m",
          "&c":"\033[0;31m",
          "&b":"\033[0;32m",
          "&Y":"\033[0;33m",
          "&u":"\033[0;34m"}
mystr = "The &yquick &cbrown &bfox &Yjumps over the &ulazy dog"

for k, v in mydict.iteritems():
    mystr = mystr.replace(k, v)

print mystr
The ←[0;30mquick ←[0;31mbrown ←[0;32mfox ←[0;33mjumps over the ←[0;34mlazy dog
</code></pre>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">took</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">liberty</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">comparing</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">few</span> <span style="background-color:yellow;">solutions</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>mydict = dict([('&' + chr(i), str(i)) for i in list(range(65, 91)) + list(range(97, 123))])

# random inserts between keys
from random import randint
rawstr = ''.join(mydict.keys())
mystr = ''
for i in range(0, len(rawstr), 2):
    mystr += chr(randint(65,91)) * randint(0,20) # insert between 0 and 20 chars

from time import time

# How many times to run each solution
rep = 10000

print 'Running %d times with string length %d and ' \
      'random inserts of lengths 0-20' % (rep, len(mystr))

# My solution
t = time()
for x in range(rep):
    for k, v in mydict.items():
        mystr.replace(k, v)
    #print(mystr)
print '%-30s' % 'Tor fixed & variable dict', time()-t

from re import sub, compile, escape

# Peter Hansen
t = time()
for x in range(rep):
    sub(r'(&[a-zA-Z])', r'%(\1)s', mystr) % mydict
print '%-30s' % 'Peter fixed & variable dict', time()-t

# Claudiu
def multiple_replace(dict, text): 
    # Create a regular expression  from the dictionary keys
    regex = compile("(%s)" % "|".join(map(escape, dict.keys())))

    # For each match, look-up corresponding value in dictionary
    return regex.sub(lambda mo: dict[mo.string[mo.start():mo.end()]], text)

t = time()
for x in range(rep):
    multiple_replace(mydict, mystr)
print '%-30s' % 'Claudio variable dict', time()-t

# Claudiu - Precompiled
regex = compile("(%s)" % "|".join(map(escape, mydict.keys())))

t = time()
for x in range(rep):
    regex.sub(lambda mo: mydict[mo.string[mo.start():mo.end()]], mystr)
print '%-30s' % 'Claudio fixed dict', time()-t

# Andrew Y - variable dict
def mysubst(somestr, somedict):
  subs = somestr.split("&")
  return subs[0] + "".join(map(lambda arg: somedict["&" + arg[0:1]] + arg[1:], subs[1:]))

t = time()
for x in range(rep):
    mysubst(mystr, mydict)
print '%-30s' % 'Andrew Y variable dict', time()-t

# Andrew Y - fixed
def repl(s):
  return mydict["&"+s[0:1]] + s[1:]

t = time()
for x in range(rep):
    subs = mystr.split("&")
    res = subs[0] + "".join(map(repl, subs[1:]))
print '%-30s' % 'Andrew Y fixed dict', time()-t
</code></pre>
<p><span style="background-color:yellow;">Results</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">2.6</span> </p>
<pre><code>Running 10000 times with string length 490 and random inserts of lengths 0-20
Tor fixed & variable dict      1.04699993134
Peter fixed & variable dict    0.218999862671
Claudio variable dict          2.48400020599
Claudio fixed dict             0.0940001010895
Andrew Y variable dict         0.0309998989105
Andrew Y fixed dict            0.0310001373291
</code></pre>
<p><span style="background-color:yellow;">Both</span> <span style="background-color:yellow;">claudiu</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">andrew</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">solutions</span> <span style="background-color:yellow;">kept</span> <span style="background-color:yellow;">going</span> <span style="background-color:yellow;">into</span> <span style="background-color:yellow;">0</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">had</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">increase</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">10</span> <span style="background-color:yellow;">000</span> <span style="background-color:yellow;">runs</span> . </p>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">ran</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">3</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">because</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">unicode</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">replacements</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">chars</span> <span style="background-color:yellow;">from</span> <span style="background-color:yellow;">39</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">1024</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">38</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">ampersand</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">did</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">wan</span> <span style="background-color:yellow;">na</span> <span style="background-color:yellow;">include</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;"></span> . <span style="background-color:yellow;">String</span> <span style="background-color:yellow;">length</span> <span style="background-color:yellow;">up</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">10.000</span> <span style="background-color:yellow;">including</span> <span style="background-color:yellow;">about</span> <span style="background-color:yellow;">980</span> <span style="background-color:yellow;">replacements</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">variable</span> <span style="background-color:yellow;">random</span> <span style="background-color:yellow;">inserts</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">length</span> <span style="background-color:yellow;">0-20.</span> <span style="background-color:yellow;">The</span> <span style="background-color:yellow;">unicode</span> <span style="background-color:yellow;">values</span> <span style="background-color:yellow;">from</span> <span style="background-color:yellow;">39</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">1024</span> <span style="background-color:yellow;">causes</span> <span style="background-color:yellow;">characters</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">both</span> <span style="background-color:yellow;">1</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">2</span> <span style="background-color:yellow;">bytes</span> <span style="background-color:yellow;">length</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">affect</span> <span style="background-color:yellow;">some</span> <span style="background-color:yellow;">solutions</span> . </p>
<pre><code>mydict = dict([('&' + chr(i), str(i)) for i in range(39,1024)])

# random inserts between keys
from random import randint
rawstr = ''.join(mydict.keys())
mystr = ''
for i in range(0, len(rawstr), 2):
    mystr += chr(randint(65,91)) * randint(0,20) # insert between 0 and 20 chars

from time import time

# How many times to run each solution
rep = 10000

print('Running %d times with string length %d and ' \
      'random inserts of lengths 0-20' % (rep, len(mystr)))

# Tor Valamo - too long
#t = time()
#for x in range(rep):
#    for k, v in mydict.items():
#        mystr.replace(k, v)
#print('%-30s' % 'Tor fixed & variable dict', time()-t)

from re import sub, compile, escape

# Peter Hansen
t = time()
for x in range(rep):
    sub(r'(&[a-zA-Z])', r'%(\1)s', mystr) % mydict
print('%-30s' % 'Peter fixed & variable dict', time()-t)

# Peter 2
def dictsub(m):
    return mydict[m.group()]

t = time()
for x in range(rep):
    sub(r'(&[a-zA-Z])', dictsub, mystr)
print('%-30s' % 'Peter fixed dict', time()-t)

# Claudiu - too long
#def multiple_replace(dict, text): 
#    # Create a regular expression  from the dictionary keys
#    regex = compile("(%s)" % "|".join(map(escape, dict.keys())))
#
#    # For each match, look-up corresponding value in dictionary
#    return regex.sub(lambda mo: dict[mo.string[mo.start():mo.end()]], text)
#
#t = time()
#for x in range(rep):
#    multiple_replace(mydict, mystr)
#print('%-30s' % 'Claudio variable dict', time()-t)

# Claudiu - Precompiled
regex = compile("(%s)" % "|".join(map(escape, mydict.keys())))

t = time()
for x in range(rep):
    regex.sub(lambda mo: mydict[mo.string[mo.start():mo.end()]], mystr)
print('%-30s' % 'Claudio fixed dict', time()-t)

# Separate setup for Andrew and gnibbler optimized dict
mydict = dict((k[1], v) for k, v in mydict.items())

# Andrew Y - variable dict
def mysubst(somestr, somedict):
  subs = somestr.split("&")
  return subs[0] + "".join(map(lambda arg: somedict[arg[0:1]] + arg[1:], subs[1:]))

def mysubst2(somestr, somedict):
  subs = somestr.split("&")
  return subs[0].join(map(lambda arg: somedict[arg[0:1]] + arg[1:], subs[1:]))

t = time()
for x in range(rep):
    mysubst(mystr, mydict)
print('%-30s' % 'Andrew Y variable dict', time()-t)
t = time()
for x in range(rep):
    mysubst2(mystr, mydict)
print('%-30s' % 'Andrew Y variable dict 2', time()-t)

# Andrew Y - fixed
def repl(s):
  return mydict[s[0:1]] + s[1:]

t = time()
for x in range(rep):
    subs = mystr.split("&")
    res = subs[0] + "".join(map(repl, subs[1:]))
print('%-30s' % 'Andrew Y fixed dict', time()-t)

# gnibbler
t = time()
for x in range(rep):
    myparts = mystr.split("&")
    myparts[1:]=[mydict[x[0]]+x[1:] for x in myparts[1:]]
    "".join(myparts)
print('%-30s' % 'gnibbler fixed & variable dict', time()-t)
</code></pre>
<p><span style="background-color:yellow;">Results</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>Running 10000 times with string length 9491 and random inserts of lengths 0-20
Tor fixed & variable dict      0.0 # disqualified 329 secs
Peter fixed & variable dict    2.07799983025
Peter fixed dict               1.53100013733 
Claudio variable dict          0.0 # disqualified, 37 secs
Claudio fixed dict             1.5
Andrew Y variable dict         0.578000068665
Andrew Y variable dict 2       0.56299996376
Andrew Y fixed dict            0.56200003624
gnibbler fixed & variable dict 0.530999898911
</code></pre>
<p><span style="background-color:yellow;"></span> <span style="background-color:yellow;">*</span> <span style="background-color:yellow;">*</span> <span style="background-color:yellow;">Note</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">gnibbler</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">uses</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">different</span> <span style="background-color:yellow;">dict</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">where</span> <span style="background-color:yellow;">keys</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">'&amp</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">'</span> <span style="background-color:yellow;">included.</span> <span style="background-color:yellow;">Andrew</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">also</span> <span style="background-color:yellow;">uses</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">alternate</span> <span style="background-color:yellow;">dict</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">did</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">make</span> <span style="background-color:yellow;">much</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">difference</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">maybe</span> <span style="background-color:yellow;">just</span> <span style="background-color:yellow;">0.01x</span> <span style="background-color:yellow;">speedup.</span> <span style="background-color:yellow;"></span> </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">1</span> </b><br /><p><span style="background-color:yellow;">Try</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">making</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">regular</span> <span style="background-color:yellow;">expression</span> <span style="background-color:yellow;">substitution</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">standard</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">formatting</span> <span style="background-color:yellow;">:</span> </p>
<pre><code># using your stated values for str and dict:
>>> import re
>>> str = re.sub(r'(&[a-zA-Z])', r'%(\1)s', str)
>>> str % dict
'The \x1b[0;30mquick \x1b[0;31mbrown \x1b[0;32mfox \x1b[0;33mjumps over the \x1b[0;34mlazy dog'
</code></pre>
<p><span style="background-color:yellow;">The</span> <span style="background-color:yellow;">re.sub</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">call</span> <span style="background-color:yellow;">replaces</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">sequences</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">ampersand</span> <span style="background-color:yellow;">followed</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">single</span> <span style="background-color:yellow;">letter</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">pattern</span> <span style="background-color:yellow;">%</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">..</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">s</span> <span style="background-color:yellow;">containing</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">same</span> <span style="background-color:yellow;">pattern</span> . </p>
<p><span style="background-color:yellow;">The</span> <span style="background-color:yellow;">%</span> <span style="background-color:yellow;">formatting</span> <span style="background-color:yellow;">takes</span> <span style="background-color:yellow;">advantage</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">feature</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">formatting</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">take</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">specify</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">substitution</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">rather</span> <span style="background-color:yellow;">than</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">commonly</span> <span style="background-color:yellow;">occurring</span> <span style="background-color:yellow;">positional</span> <span style="background-color:yellow;">arguments</span> . </p>
<p><span style="background-color:yellow;">An</span> <span style="background-color:yellow;">alternative</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">directly</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">re.sub</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">callback</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>>>> import re
>>> def dictsub(m):
>>>    return dict[m.group()]
>>> str = re.sub(r'(&[a-zA-Z])', dictsub, str)
</code></pre>
<p><span style="background-color:yellow;">This</span> <span style="background-color:yellow;">time</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'m</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">closure</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">reference</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">from</span> <span style="background-color:yellow;">inside</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">callback</span> <span style="background-color:yellow;">function.</span> <span style="background-color:yellow;">This</span> <span style="background-color:yellow;">approach</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">give</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">little</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">flexibility.</span> <span style="background-color:yellow;">For</span> <span style="background-color:yellow;">example</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">something</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">dict.get</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">m.group</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">'</span> ? ? <span style="background-color:yellow;">'</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">avoid</span> <span style="background-color:yellow;">raising</span> <span style="background-color:yellow;">exceptions</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">had</span> <span style="background-color:yellow;">strings</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">unrecognized</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">sequences</span> . </p>
<p><span style="background-color:yellow;"></span> <span style="background-color:yellow;">By</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">way</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">both</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">dict</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">str</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">builtin</span> <span style="background-color:yellow;">functions</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">'ll</span> <span style="background-color:yellow;">get</span> <span style="background-color:yellow;">into</span> <span style="background-color:yellow;">trouble</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">those</span> <span style="background-color:yellow;">names</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">own</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">much.</span> <span style="background-color:yellow;">Just</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">case</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">did</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">know</span> <span style="background-color:yellow;">that.</span> <span style="background-color:yellow;">They</span> <span style="background-color:yellow;">'re</span> <span style="background-color:yellow;">fine</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">question</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">course.</span> <span style="background-color:yellow;"></span> </p>
<p><span style="background-color:yellow;">Edit</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">decided</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">check</span> <span style="background-color:yellow;">Tor</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">test</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">concluded</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">nowhere</span> <span style="background-color:yellow;">near</span> <span style="background-color:yellow;">representative</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">fact</span> <span style="background-color:yellow;">buggy.</span> <span style="background-color:yellow;">The</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">generated</span> <span style="background-color:yellow;">does</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">even</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">ampersands</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">!</span> <span style="background-color:yellow;"></span> . <span style="background-color:yellow;">The</span> <span style="background-color:yellow;">revised</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">below</span> <span style="background-color:yellow;">generates</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">representative</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">similar</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">OP</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">example</span> <span style="background-color:yellow;">inputs</span> . </p>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">also</span> <span style="background-color:yellow;">wanted</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">verify</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">each</span> <span style="background-color:yellow;">algorithm</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">output</span> <span style="background-color:yellow;">was</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">same.</span> <span style="background-color:yellow;">Below</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">revised</span> <span style="background-color:yellow;">test</span> <span style="background-color:yellow;">program</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">only</span> <span style="background-color:yellow;">Tor</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">mine</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">Claudiu</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">--</span> <span style="background-color:yellow;">because</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">others</span> <span style="background-color:yellow;">were</span> <span style="background-color:yellow;">breaking</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">sample</span> <span style="background-color:yellow;">input.</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">think</span> <span style="background-color:yellow;">they</span> <span style="background-color:yellow;">'re</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">brittle</span> <span style="background-color:yellow;">unless</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">maps</span> <span style="background-color:yellow;">basically</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">possible</span> <span style="background-color:yellow;">ampersand</span> <span style="background-color:yellow;">sequences</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">Tor</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">test</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">was</span> <span style="background-color:yellow;">doing.</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">This</span> <span style="background-color:yellow;">one</span> <span style="background-color:yellow;">properly</span> <span style="background-color:yellow;">seeds</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">random</span> <span style="background-color:yellow;">number</span> <span style="background-color:yellow;">generator</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">each</span> <span style="background-color:yellow;">run</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">same.</span> <span style="background-color:yellow;">Finally</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">added</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">minor</span> <span style="background-color:yellow;">variation</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">generator</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">avoids</span> <span style="background-color:yellow;">some</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">call</span> <span style="background-color:yellow;">overhead</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">minor</span> <span style="background-color:yellow;">performance</span> <span style="background-color:yellow;">improvement</span> . </p>
<pre><code>from time import time
import string
import random
import re

random.seed(1919096)  # ensure consistent runs

# build dictionary with 40 mappings, representative of original question
mydict = dict(('&' + random.choice(string.letters), '\x1b[0;%sm' % (30+i)) for i in range(40))
# build simulated input, with mix of text, spaces, ampersands in reasonable proportions
letters = string.letters + ' ' * 12 + '&' * 6
mystr = ''.join(random.choice(letters) for i in range(1000))

# How many times to run each solution
rep = 10000

print('Running %d times with string length %d and %d ampersands'
    % (rep, len(mystr), mystr.count('&')))

# Tor Valamo
# fixed from Tor's test, so it actually builds up the final string properly
t = time()
for x in range(rep):
    output = mystr
    for k, v in mydict.items():
        output = output.replace(k, v)
print('%-30s' % 'Tor fixed & variable dict', time() - t)
# capture "known good" output as expected, to verify others
expected = output

# Peter Hansen

# build charset to use in regex for safe dict lookup
charset = ''.join(x[1] for x in mydict.keys())
# grab reference to method on regex, for speed
patsub = re.compile(r'(&[%s])' % charset).sub

t = time()
for x in range(rep):
    output = patsub(r'%(\1)s', mystr) % mydict
print('%-30s' % 'Peter fixed & variable dict', time()-t)
assert output == expected

# Peter 2
def dictsub(m):
    return mydict[m.group()]

t = time()
for x in range(rep):
    output = patsub(dictsub, mystr)
print('%-30s' % 'Peter fixed dict', time() - t)
assert output == expected

# Peter 3 - freaky generator version, to avoid function call overhead
def dictsub(d):
    m = yield None
    while 1:
        m = yield d[m.group()]

dictsub = dictsub(mydict).send
dictsub(None)   # "prime" it
t = time()
for x in range(rep):
    output = patsub(dictsub, mystr)
print('%-30s' % 'Peter generator', time() - t)
assert output == expected

# Claudiu - Precompiled
regex_sub = re.compile("(%s)" % "|".join(mydict.keys())).sub

t = time()
for x in range(rep):
    output = regex_sub(lambda mo: mydict[mo.string[mo.start():mo.end()]], mystr)
print('%-30s' % 'Claudio fixed dict', time() - t)
assert output == expected
</code></pre>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">forgot</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">include</span> <span style="background-color:yellow;">benchmark</span> <span style="background-color:yellow;">results</span> <span style="background-color:yellow;">before</span> <span style="background-color:yellow;">:</span> </p>
<pre>
    Running 10000 times with string length 1000 and 96 ampersands
    ('Tor fixed & variable dict     ', 2.9890000820159912)
    ('Peter fixed & variable dict   ', 2.6659998893737793)
    ('Peter fixed dict              ', 1.0920000076293945)
    ('Peter generator               ', 1.0460000038146973)
    ('Claudio fixed dict            ', 1.562000036239624)
</pre>
<p><span style="background-color:yellow;">Also</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">snippets</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">inputs</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">correct</span> <span style="background-color:yellow;">output</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>mystr = 'lTEQDMAPvksk k&z Txp vrnhQ GHaO&GNFY&&a...'
mydict = {'&p': '\x1b[0;37m', '&q': '\x1b[0;66m', '&v': ...}
output = 'lTEQDMAPvksk k←[0;57m Txp vrnhQ GHaO←[0;67mNFY&&a P...'
</code></pre>
<p><span style="background-color:yellow;">Comparing</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">what</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">saw</span> <span style="background-color:yellow;">from</span> <span style="background-color:yellow;">Tor</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">test</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">output</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>mystr = 'VVVVVVVPPPPPPPPPPPPPPPXXXXXXXXYYYFFFFFFFFFFFFEEEEEEEEEEE...'
mydict = {'&p': '112', '&q': '113', '&r': '114', '&s': '115', ...}
output = # same as mystr since there were no ampersands inside
</code></pre>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">2</span> </b><br /><p><span style="background-color:yellow;">If</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">number</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">keys</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">list</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">large</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">number</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">occurences</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">low</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">mostly</span> <span style="background-color:yellow;">zero</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">then</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">iterate</span> <span style="background-color:yellow;">over</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">occurences</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">ampersands</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">keyed</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">first</span> <span style="background-color:yellow;">character</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">substrings.</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">often</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">python</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">style</span> <span style="background-color:yellow;">might</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">bit</span> <span style="background-color:yellow;">off</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">here</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">take</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>str = "The &yquick &cbrown &bfox &Yjumps over the &ulazy dog"

dict = {"&y":"\033[0;30m",
        "&c":"\033[0;31m",
        "&b":"\033[0;32m",
        "&Y":"\033[0;33m",
        "&u":"\033[0;34m"}

def rep(s):
  return dict["&"+s[0:1]] + s[1:]

subs = str.split("&")
res = subs[0] + "".join(map(rep, subs[1:]))

print res
</code></pre>
<p><span style="background-color:yellow;">Of</span> <span style="background-color:yellow;">course</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">question</span> <span style="background-color:yellow;">what</span> <span style="background-color:yellow;">happens</span> <span style="background-color:yellow;">when</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">ampersand</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">coming</span> <span style="background-color:yellow;">from</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">itself</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">would</span> <span style="background-color:yellow;">need</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">escape</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">some</span> <span style="background-color:yellow;">way</span> <span style="background-color:yellow;">before</span> <span style="background-color:yellow;">feeding</span> <span style="background-color:yellow;">through</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">process</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">then</span> <span style="background-color:yellow;">unescape</span> <span style="background-color:yellow;">after</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">process</span> . </p>
<p><span style="background-color:yellow;">Of</span> <span style="background-color:yellow;">course</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">pretty</span> <span style="background-color:yellow;">much</span> <span style="background-color:yellow;">usual</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">performance</span> <span style="background-color:yellow;">issues</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">timing</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">various</span> <span style="background-color:yellow;">approaches</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">typical</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">also</span> <span style="background-color:yellow;">worst-case</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">dataset</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">comparing</span> <span style="background-color:yellow;">them</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">good</span> <span style="background-color:yellow;">thing</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">do</span> . </p>
<p><span style="background-color:yellow;">EDIT</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">place</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">into</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">separate</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">work</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">arbitrary</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>def mysubst(somestr, somedict):
  subs = somestr.split("&")
  return subs[0] + "".join(map(lambda arg: somedict["&" + arg[0:1]] + arg[1:], subs[1:]))
</code></pre>
<p><span style="background-color:yellow;">EDIT2</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">get</span> <span style="background-color:yellow;">rid</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">unneeded</span> <span style="background-color:yellow;">concatenation</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">seems</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">still</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">bit</span> <span style="background-color:yellow;">faster</span> <span style="background-color:yellow;">than</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">previous</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">many</span> <span style="background-color:yellow;">iterations</span> . </p>
<pre><code>def mysubst(somestr, somedict):
  subs = somestr.split("&")
  return subs[0].join(map(lambda arg: somedict["&" + arg[0:1]] + arg[1:], subs[1:]))
</code></pre>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">3</span> </b><br /><p><span style="background-color:yellow;">If</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">really</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">dig</span> <span style="background-color:yellow;">into</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">topic</span> <span style="background-color:yellow;">take</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">look</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">http</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">//en.wikipedia.org/wiki/Aho-Corasick</span> <span style="background-color:yellow;">%</span> <span style="background-color:yellow;">5Falgorithm</span> </p>
<p><span style="background-color:yellow;">The</span> <span style="background-color:yellow;">obvious</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">iterating</span> <span style="background-color:yellow;">over</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">replacing</span> <span style="background-color:yellow;">each</span> <span style="background-color:yellow;">element</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">takes</span> <span style="background-color:yellow;">O</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">n</span> <span style="background-color:yellow;">*</span> <span style="background-color:yellow;">m</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">time</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">where</span> <span style="background-color:yellow;">n</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">size</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">m</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">length</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">string</span> . </p>
<p><span style="background-color:yellow;">Whereas</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">Aho-Corasick-Algorithm</span> <span style="background-color:yellow;">finds</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">entries</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">O</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">n</span> <span style="background-color:yellow;">+</span> <span style="background-color:yellow;">m</span> <span style="background-color:yellow;">+</span> <span style="background-color:yellow;">f</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">where</span> <span style="background-color:yellow;">f</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">number</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">found</span> <span style="background-color:yellow;">elements</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">4</span> </b><br /><p><span style="background-color:yellow;">Here</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">Extensions</span> <span style="background-color:yellow;">Approach</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">python</span> </p>
<pre><code>const char *dvals[]={
    //"0-64
    "","","","","","","","","","",
    "","","","","","","","","","",
    "","","","","","","","","","",
    "","","","","","","","","","",
    "","","","","","","","","","",
    "","","","","","","","","","",
    "","","","","",
    //A-Z
    "","","","","",
    "","","","","",
    "","","","","",
    "","","","","",
    "","","","","33",
    "",
    //
    "","","","","","",
    //a-z
    "","32","31","","",
    "","","","","",
    "","","","","",
    "","","","","",
    "34","","","","30",
    ""
};

int dsub(char*d,char*s){
    char *ofs=d;
    do{
    	if(*s=='&' && s[1]<='z' && *dvals[s[1]]){

    		//\033[0;
    		*d++='\\',*d++='0',*d++='3',*d++='3',*d++='[',*d++='0',*d++=';';

    		//consider as fixed 2 digits
    		*d++=dvals[s[1]][0];
    		*d++=dvals[s[1]][1];

    		*d++='m';

    		s++; //skip

    	//non &,invalid, unused (&) ampersand sequences will go here.
    	}else *d++=*s;

    }while(*s++);

    return d-ofs-1;
}
</code></pre>
<p><span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">codes</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">tested</span> </p>
<pre><code>from mylib import *
import time

start=time.time()

instr="The &yquick &cbrown &bfox &Yjumps over the &ulazy dog, skip &Unknown.\n"*100000
x=dsub(instr)

end=time.time()

print "time taken",end-start,",input str length",len(x)
print "first few lines"
print x[:1100]
</code></pre>
<p><span style="background-color:yellow;">Results</span> </p>
<pre><code>time taken 0.140000104904 ,input str length 11000000
first few lines
The \033[0;30mquick \033[0;31mbrown \033[0;32mfox \033[0;33mjumps over the \033[0;34mlazy dog, skip &Unknown.
The \033[0;30mquick \033[0;31mbrown \033[0;32mfox \033[0;33mjumps over the \033[0;34mlazy dog, skip &Unknown.
The \033[0;30mquick \033[0;31mbrown \033[0;32mfox \033[0;33mjumps over the \033[0;34mlazy dog, skip &Unknown.
The \033[0;30mquick \033[0;31mbrown \033[0;32mfox \033[0;33mjumps over the \033[0;34mlazy dog, skip &Unknown.
The \033[0;30mquick \033[0;31mbrown \033[0;32mfox \033[0;33mjumps over the \033[0;34mlazy dog, skip &Unknown.
The \033[0;30mquick \033[0;31mbrown \033[0;32mfox \033[0;33mjumps over the \033[0;34mlazy dog, skip &Unknown.
The \033[0;30mquick \033[0;31mbrown \033[0;32mfox \033[0;33mjumps over the \033[0;34mlazy dog, skip &Unknown.
The \033[0;30mquick \033[0;31mbrown \033[0;32mfox \033[0;33mjumps over the \033[0;34mlazy dog, skip &Unknown.
The \033[0;30mquick \033[0;31mbrown \033[0;32mfox \033[0;33mjumps over the \033[0;34mlazy dog, skip &Unknown.
The \033[0;30mquick \033[0;31mbrown \033[0;32mfox \033[0;33mjumps over the \033[0;34mlazy dog, skip &Unknown.
</code></pre>
<p><span style="background-color:yellow;">Its</span> <span style="background-color:yellow;">suppose</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">able</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">run</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">O</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">n</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">Only</span> <span style="background-color:yellow;">took</span> <span style="background-color:yellow;">160</span> <span style="background-color:yellow;">ms</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">avg</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">11</span> <span style="background-color:yellow;">MB</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">My</span> <span style="background-color:yellow;">Mobile</span> <span style="background-color:yellow;">Celeron</span> <span style="background-color:yellow;">1.6</span> <span style="background-color:yellow;">GHz</span> <span style="background-color:yellow;">PC</span> </p>
<p><span style="background-color:yellow;">It</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">also</span> <span style="background-color:yellow;">skip</span> <span style="background-color:yellow;">unknown</span> <span style="background-color:yellow;">characters</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">example</span> <span style="background-color:yellow;">&amp</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">Unknown</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">return</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">is</span> </p>
<p><span style="background-color:yellow;">Let</span> <span style="background-color:yellow;">me</span> <span style="background-color:yellow;">know</span> <span style="background-color:yellow;">If</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">any</span> <span style="background-color:yellow;">problem</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">compiling</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">bugs</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">etc..</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">5</span> </b><br /><p><span style="background-color:yellow;">Here</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">version</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">split/join</span> </p>
<pre><code>mydict = {"y":"\033[0;30m",
          "c":"\033[0;31m",
          "b":"\033[0;32m",
          "Y":"\033[0;33m",
          "u":"\033[0;34m"}
mystr = "The &yquick &cbrown &bfox &Yjumps over the &ulazy dog"

myparts = mystr.split("&")
myparts[1:]=[mydict[x[0]]+x[1:] for x in myparts[1:]]
print "".join(myparts)
</code></pre>
<p><span style="background-color:yellow;">In</span> <span style="background-color:yellow;">case</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">ampersands</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">invalid</span> <span style="background-color:yellow;">codes</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">preserve</span> <span style="background-color:yellow;">them</span> </p>
<pre><code>myparts[1:]=[mydict.get(x[0],"&"+x[0])+x[1:] for x in myparts[1:]]
</code></pre>
<p><span style="background-color:yellow;">Peter</span> <span style="background-color:yellow;">Hansen</span> <span style="background-color:yellow;">pointed</span> <span style="background-color:yellow;">out</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">fails</span> <span style="background-color:yellow;">when</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">double</span> <span style="background-color:yellow;">ampersand.</span> <span style="background-color:yellow;">In</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">case</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">version</span> </p>
<pre><code>mystr = "The &yquick &cbrown &bfox &Yjumps over the &&ulazy dog"
myparts = mystr.split("&")
myparts[1:]=[mydict.get(x[:1],"&"+x[:1])+x[1:] for x in myparts[1:]]
print "".join(myparts)
</code></pre>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">6</span> </b><br /><p><span style="background-color:yellow;">This</span> <span style="background-color:yellow;">seems</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">does</span> <span style="background-color:yellow;">what</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">-</span> <span style="background-color:yellow;">multiple</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">replace</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">once</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">RegExps.</span> <span style="background-color:yellow;">Here</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">relevant</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>def multiple_replace(dict, text): 
    # Create a regular expression  from the dictionary keys
    regex = re.compile("(%s)" % "|".join(map(re.escape, dict.keys())))

    # For each match, look-up corresponding value in dictionary
    return regex.sub(lambda mo: dict[mo.string[mo.start():mo.end()]], text)

print multiple_replace(dict, str)
</code></pre>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">7</span> </b><br /><p><span style="background-color:yellow;">A</span> <span style="background-color:yellow;">general</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">defining</span> <span style="background-color:yellow;">replacement</span> <span style="background-color:yellow;">rules</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">regex</span> <span style="background-color:yellow;">substitution</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">provide</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">map</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">see</span> <span style="background-color:yellow;">re.sub</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> . </p>
<pre><code>import re

str = "The &yquick &cbrown &bfox &Yjumps over the &ulazy dog"

dict = {"&y":"\033[0;30m",
        "&c":"\033[0;31m",
        "&b":"\033[0;32m",
        "&Y":"\033[0;33m",
        "&u":"\033[0;34m"}

def programmaticReplacement( match ):
    return dict[ match.group( 1 ) ]

colorstring = re.sub( '(\&.)', programmaticReplacement, str )
</code></pre>
<p><span style="background-color:yellow;">This</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">particularly</span> <span style="background-color:yellow;">nice</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">non-trivial</span> <span style="background-color:yellow;">substitutions</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">e.g</span> <span style="background-color:yellow;">anything</span> <span style="background-color:yellow;">requiring</span> <span style="background-color:yellow;">mathmatical</span> <span style="background-color:yellow;">operations</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">create</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">substitute</span> <span style="background-color:yellow;"></span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">8</span> </b><br /><p><span style="background-color:yellow;">Not</span> <span style="background-color:yellow;">sure</span> <span style="background-color:yellow;">about</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">speed</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;">either</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">just</span> <span style="background-color:yellow;">loop</span> <span style="background-color:yellow;">through</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">repeatedly</span> <span style="background-color:yellow;">call</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">built-in</span> </p>
<p><span style="background-color:yellow;">str.replace</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">old</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">new</span> <span style="background-color:yellow;"></span> </p>
<p><span style="background-color:yellow;">This</span> <span style="background-color:yellow;">might</span> <span style="background-color:yellow;">perform</span> <span style="background-color:yellow;">decently</span> <span style="background-color:yellow;">well</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">original</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">too</span> <span style="background-color:yellow;">long</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">would</span> <span style="background-color:yellow;">obviously</span> <span style="background-color:yellow;">suffer</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">got</span> <span style="background-color:yellow;">longer</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">9</span> </b><br /><p><span style="background-color:yellow;">The</span> <span style="background-color:yellow;">problem</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">doing</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">mass</span> <span style="background-color:yellow;">replace</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">immutability</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">strings</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">every</span> <span style="background-color:yellow;">time</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">replace</span> <span style="background-color:yellow;">one</span> <span style="background-color:yellow;">item</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">then</span> <span style="background-color:yellow;">entire</span> <span style="background-color:yellow;">new</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">reallocated</span> <span style="background-color:yellow;">again</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">again</span> <span style="background-color:yellow;">from</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">heap</span> . </p>
<p><span style="background-color:yellow;">So</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">fastest</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">either</span> <span style="background-color:yellow;">need</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">mutable</span> <span style="background-color:yellow;">container</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">e.g.</span> <span style="background-color:yellow;">list</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">write</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">machinery</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">plain</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">better</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">Pyrex</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">Cython</span> <span style="background-color:yellow;"></span> . <span style="background-color:yellow;">In</span> <span style="background-color:yellow;">any</span> <span style="background-color:yellow;">case</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'d</span> <span style="background-color:yellow;">suggest</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">write</span> <span style="background-color:yellow;">simple</span> <span style="background-color:yellow;">parser</span> <span style="background-color:yellow;">based</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">simple</span> <span style="background-color:yellow;">finite-state</span> <span style="background-color:yellow;">machine</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">feed</span> <span style="background-color:yellow;">symbols</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">one</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">one</span> . </p>
<p><span style="background-color:yellow;">Suggested</span> <span style="background-color:yellow;">solutions</span> <span style="background-color:yellow;">based</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">regexps</span> <span style="background-color:yellow;">working</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">similar</span> <span style="background-color:yellow;">way</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">because</span> <span style="background-color:yellow;">regexp</span> <span style="background-color:yellow;">working</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">fsm</span> <span style="background-color:yellow;">behind</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">scene</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">10</span> </b><br /><p><span style="background-color:yellow;">Since</span> <span style="background-color:yellow;">someone</span> <span style="background-color:yellow;">mentioned</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">simple</span> <span style="background-color:yellow;">parser</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">thought</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'d</span> <span style="background-color:yellow;">cook</span> <span style="background-color:yellow;">one</span> <span style="background-color:yellow;">up</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">pyparsing.</span> <span style="background-color:yellow;">By</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">pyparsing</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">transformString</span> <span style="background-color:yellow;">method</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">pyparsing</span> <span style="background-color:yellow;">internally</span> <span style="background-color:yellow;">scans</span> <span style="background-color:yellow;">through</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">source</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">builds</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">list</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">matching</span> <span style="background-color:yellow;">text</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">intervening</span> <span style="background-color:yellow;">text.</span> <span style="background-color:yellow;">When</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">done</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">transformString</span> <span style="background-color:yellow;">then</span> <span style="background-color:yellow;">''.join</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">list</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">no</span> <span style="background-color:yellow;">performance</span> <span style="background-color:yellow;">problem</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">building</span> <span style="background-color:yellow;">up</span> <span style="background-color:yellow;">strings</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">increments.</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">The</span> <span style="background-color:yellow;">parse</span> <span style="background-color:yellow;">action</span> <span style="background-color:yellow;">defined</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">ANSIreplacer</span> <span style="background-color:yellow;">does</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">conversion</span> <span style="background-color:yellow;">from</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">matched</span> <span style="background-color:yellow;">&amp</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">_</span> <span style="background-color:yellow;">characters</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">desired</span> <span style="background-color:yellow;">escape</span> <span style="background-color:yellow;">sequence</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">replaces</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">matched</span> <span style="background-color:yellow;">text</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">output</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">parse</span> <span style="background-color:yellow;">action.</span> <span style="background-color:yellow;">Since</span> <span style="background-color:yellow;">only</span> <span style="background-color:yellow;">matching</span> <span style="background-color:yellow;">sequences</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">satisfy</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">parser</span> <span style="background-color:yellow;">expression</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">no</span> <span style="background-color:yellow;">need</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">parse</span> <span style="background-color:yellow;">action</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">handle</span> <span style="background-color:yellow;">undefined</span> <span style="background-color:yellow;">&amp</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">_</span> <span style="background-color:yellow;">sequences.</span> <span style="background-color:yellow;"></span> </p>
<p><span style="background-color:yellow;">The</span> <span style="background-color:yellow;">FollowedBy</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">'&amp</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">'</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">strictly</span> <span style="background-color:yellow;">necessary</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">shortcuts</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">parsing</span> <span style="background-color:yellow;">process</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">verifying</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">parser</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">actually</span> <span style="background-color:yellow;">positioned</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">ampersand</span> <span style="background-color:yellow;">before</span> <span style="background-color:yellow;">doing</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">expensive</span> <span style="background-color:yellow;">checking</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">markup</span> <span style="background-color:yellow;">options</span> . </p>
<pre><code>from pyparsing import FollowedBy, oneOf

escLookup = {"&y":"\033[0;30m",
            "&c":"\033[0;31m",
            "&b":"\033[0;32m",
            "&Y":"\033[0;33m",
            "&u":"\033[0;34m"}

# make a single expression that will look for a leading '&', then try to 
# match each of the escape expressions
ANSIreplacer = FollowedBy('&') + oneOf(escLookup.keys())

# add a parse action that will replace the matched text with the 
# corresponding ANSI sequence
ANSIreplacer.setParseAction(lambda toks: escLookup[toks[0]])

# now use the replacer to transform the test string; throw in some extra
# ampersands to show what happens with non-matching sequences
src = "The &yquick &cbrown &bfox &Yjumps over the &ulazy dog & &Zjumps back"
out = ANSIreplacer.transformString(src)
print repr(out)
</code></pre>
<p><span style="background-color:yellow;">Prints</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>'The \x1b[0;30mquick \x1b[0;31mbrown \x1b[0;32mfox \x1b[0;33mjumps over 
 the \x1b[0;34mlazy dog & &Zjumps back'
</code></pre>
<p><span style="background-color:yellow;">This</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">certainly</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">win</span> <span style="background-color:yellow;">any</span> <span style="background-color:yellow;">performance</span> <span style="background-color:yellow;">contests</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">markup</span> <span style="background-color:yellow;">starts</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">get</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">complicated</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">then</span> <span style="background-color:yellow;">having</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">parser</span> <span style="background-color:yellow;">foundation</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">make</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">easier</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">extend</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">11</span> </b><br /><pre><code>>>> a=[]
>>> str = "The &yquick &cbrown &bfox &Yjumps over the &ulazy dog"
>>> d={"&y":"\033[0;30m",                                                              
... "&c":"\033[0;31m",                                                                 
... "&b":"\033[0;32m",                                                                 
... "&Y":"\033[0;33m",                                                                 
... "&u":"\033[0;34m"}     
>>> for item in str.split():
...  if item[:2] in d:
...    a.append(d[item[:2]]+item[2:])
...  else: a.append(item)
>>> print ' '.join(a)
</code></pre>
<br />