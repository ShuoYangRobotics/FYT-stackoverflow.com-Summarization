<h3><span style="background-color:yellow;">Question</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">ID-7699912</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">:</span> </h3><h2><span style="background-color:yellow;">Clean</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">type-safe</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">machine</span> <span style="background-color:yellow;">implementation</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">statically</span> <span style="background-color:yellow;">typed</span> <span style="background-color:yellow;">language</span> ? </h2><p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">implemented</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">simple</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">machine</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>import time

def a():
    print "a()"
    return b

def b():
    print "b()"
    return c

def c():
    print "c()"
    return a


if __name__ == "__main__":
    state = a
    while True:
        state = state()
        time.sleep(1)
</code></pre>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">wanted</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">port</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">because</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">was</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">fast</span> <span style="background-color:yellow;">enough.</span> <span style="background-color:yellow;">But</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">does</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">let</span> <span style="background-color:yellow;">me</span> <span style="background-color:yellow;">make</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">returns</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">same</span> <span style="background-color:yellow;">type.</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">tried</span> <span style="background-color:yellow;">making</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">typedef</span> <span style="background-color:yellow;">*</span> <span style="background-color:yellow;">fn</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">fn</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">does</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">work</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">had</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">structure</span> <span style="background-color:yellow;">instead.</span> <span style="background-color:yellow;">Now</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">very</span> <span style="background-color:yellow;">ugly</span> <span style="background-color:yellow;">!</span> </p>
<pre><code>#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

typedef struct fn {
    struct fn (*f)(void);
} fn_t;

fn_t a(void);
fn_t b(void);
fn_t c(void);

fn_t a(void)
{
    fn_t f = {b};

    (void)printf("a()\n");

    return f;
}

fn_t b(void)
{
    fn_t f = {c};

    (void)printf("b()\n");

    return f;
}

fn_t c(void)
{
    fn_t f = {a};

    (void)printf("c()\n");

    return f;
}

int main(void)
{
    fn_t state = {a};

    for(;; (void)sleep(1)) state = state.f();

    return EXIT_SUCCESS;
}
</code></pre>
<p><span style="background-color:yellow;">So</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">figured</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">problem</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">broken</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">system.</span> <span style="background-color:yellow;">So</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">used</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">language</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">real</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">system</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">Haskell</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">same</span> <span style="background-color:yellow;">problem</span> <span style="background-color:yellow;">happens.</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">ca</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">just</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">something</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>type Fn = IO Fn
a :: Fn
a = print "a()" >> return b
b :: Fn
b = print "b()" >> return c
c :: Fn
c = print "c()" >> return a
</code></pre>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">get</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">error</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">Cycle</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">synonym</span> <span style="background-color:yellow;">declarations</span> . </p>
<p><span style="background-color:yellow;">So</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">make</span> <span style="background-color:yellow;">some</span> <span style="background-color:yellow;">wrapper</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">same</span> <span style="background-color:yellow;">way</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">did</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>import Control.Monad
import System.Posix

data Fn = Fn (IO Fn)

a :: IO Fn
a = print "a()" >> return (Fn b)

b :: IO Fn
b = print "b()" >> return (Fn c)

c :: IO Fn
c = print "c()" >> return (Fn a)

run = foldM (\(Fn f) () -> sleep 1 >> f) (Fn a) (repeat ())
</code></pre>
<p><span style="background-color:yellow;">Why</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">hard</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">make</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">machine</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">statically</span> <span style="background-color:yellow;">typed</span> <span style="background-color:yellow;">language</span> ? <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">make</span> <span style="background-color:yellow;">unnecessary</span> <span style="background-color:yellow;">overhead</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">statically</span> <span style="background-color:yellow;">typed</span> <span style="background-color:yellow;">languages</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">well.</span> <span style="background-color:yellow;">Dynamically</span> <span style="background-color:yellow;">typed</span> <span style="background-color:yellow;">languages</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">problem.</span> <span style="background-color:yellow;">Is</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">easier</span> <span style="background-color:yellow;">way</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">statically</span> <span style="background-color:yellow;">typed</span> <span style="background-color:yellow;">language</span> ? </p>
<br /><h3><span style="background-color:yellow;">Answers</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">Total-11</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">:</span> </h3><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">0</span> </b><br /><p><span style="background-color:yellow;">In</span> <span style="background-color:yellow;">Haskell</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">idiom</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">just</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">go</span> <span style="background-color:yellow;">ahead</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">execute</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">next</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>type StateMachine = IO ()
a, b, c :: StateMachine
a = print "a()" >> b
b = print "b()" >> c
c = print "c()" >> a
</code></pre>
<p><span style="background-color:yellow;">You</span> <span style="background-color:yellow;">need</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">worry</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">overflow</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">stack</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">anything</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">that.</span> <span style="background-color:yellow;">If</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">insist</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">having</span> <span style="background-color:yellow;">states</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">then</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">should</span> <span style="background-color:yellow;">make</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">data</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">explicit</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>data PossibleStates = A | B | C
type StateMachine = PossibleStates -> IO PossibleStates
machine A = print "a()" >> return B
machine B = print "b()" >> return C
machine C = print "c()" >> return A
</code></pre>
<p><span style="background-color:yellow;">You</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">then</span> <span style="background-color:yellow;">get</span> <span style="background-color:yellow;">compiler</span> <span style="background-color:yellow;">warnings</span> <span style="background-color:yellow;">about</span> <span style="background-color:yellow;">any</span> <span style="background-color:yellow;">StateMachine</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">forgot</span> <span style="background-color:yellow;">some</span> <span style="background-color:yellow;">states</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">1</span> </b><br /><p><span style="background-color:yellow;">If</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">newtype</span> <span style="background-color:yellow;">instead</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">data</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">incur</span> <span style="background-color:yellow;">any</span> <span style="background-color:yellow;">overhead.</span> <span style="background-color:yellow;">Also</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">wrap</span> <span style="background-color:yellow;">each</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">point</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">definition</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">expressions</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">them</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>import Control.Monad

newtype State = State { runState :: IO State }

a :: State
a = State $ print "a()" >> return b

b :: State
b = State $ print "b()" >> return c

c :: State
c = State $ print "c()" >> return a

runMachine :: State -> IO ()
runMachine s = runMachine =<< runState s

main = runMachine a
</code></pre>
<p><span style="background-color:yellow;">Edit</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">struck</span> <span style="background-color:yellow;">me</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">runMachine</span> <span style="background-color:yellow;">has</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">general</span> <span style="background-color:yellow;">form</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">monadic</span> <span style="background-color:yellow;">version</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">iterate</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>iterateM :: Monad m => (a -> m a) -> a -> m [a]
iterateM f a = do { b <- f a
                  ; as <- iterateM f b
                  ; return (a:as)
                  }

main = iterateM runState a
</code></pre>
<p><span style="background-color:yellow;">Edit</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">Hmm</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">iterateM</span> <span style="background-color:yellow;">causes</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">space-leak.</span> <span style="background-color:yellow;">Maybe</span> <span style="background-color:yellow;">iterateM_</span> <span style="background-color:yellow;">would</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">better</span> . </p>
<pre><code>iterateM_ :: Monad m => (a -> m a) -> a -> m ()
iterateM_ f a = f a >>= iterateM_ f

main = iterateM_ runState a
</code></pre>
<p><span style="background-color:yellow;">Edit</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">If</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">thread</span> <span style="background-color:yellow;">some</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">through</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">machine</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">same</span> <span style="background-color:yellow;">definition</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">State</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">change</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">functions</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>a :: Int -> State
a i = State $ do{ print $ "a(" ++ show i ++ ")"
                ; return $ b (i+1)
                }

b :: Int -> State
b i = State $ do{ print $ "b(" ++ show i ++ ")"
                ; return $ c (i+1)
                }

c :: Int -> State
c i = State $ do{ print $ "c(" ++ show i ++ ")"
                ; return $ a (i+1)
                }

main = iterateM_ runState $ a 1
</code></pre>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">2</span> </b><br /><p><span style="background-color:yellow;">In</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">C-like</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">systems</span> <span style="background-color:yellow;">functions</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">first</span> <span style="background-color:yellow;">order</span> <span style="background-color:yellow;">citizens.</span> <span style="background-color:yellow;">There</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">certain</span> <span style="background-color:yellow;">restrictions</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">handling</span> <span style="background-color:yellow;">them.</span> <span style="background-color:yellow;">That</span> <span style="background-color:yellow;">was</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">decision</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">simplicity</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">speed</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">implementation/execution</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">stuck.</span> <span style="background-color:yellow;">To</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">functions</span> <span style="background-color:yellow;">behave</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">objects</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">one</span> <span style="background-color:yellow;">generally</span> <span style="background-color:yellow;">requires</span> <span style="background-color:yellow;">support</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">closures.</span> <span style="background-color:yellow;">Those</span> <span style="background-color:yellow;">however</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">naturally</span> <span style="background-color:yellow;">supported</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">mosts</span> <span style="background-color:yellow;">processors</span> <span style="background-color:yellow;">'</span> <span style="background-color:yellow;">instruction</span> <span style="background-color:yellow;">sets.</span> <span style="background-color:yellow;">As</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">was</span> <span style="background-color:yellow;">designed</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">close</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">metal</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">was</span> <span style="background-color:yellow;">no</span> <span style="background-color:yellow;">support</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">them</span> . </p>
<p><span style="background-color:yellow;">When</span> <span style="background-color:yellow;">declaring</span> <span style="background-color:yellow;">recursive</span> <span style="background-color:yellow;">structures</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">must</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">fully</span> <span style="background-color:yellow;">expandable.</span> <span style="background-color:yellow;">A</span> <span style="background-color:yellow;">consequence</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">only</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">pointers</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">self-references</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">struct</span> <span style="background-color:yellow;">declarations</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>struct rec;
struct rec {
    struct rec *next;
};
</code></pre>
<p><span style="background-color:yellow;">Also</span> <span style="background-color:yellow;">every</span> <span style="background-color:yellow;">identifier</span> <span style="background-color:yellow;">we</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">has</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">declared.</span> <span style="background-color:yellow;">One</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">restrictions</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">function-types</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">one</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">forward</span> <span style="background-color:yellow;">declare</span> <span style="background-color:yellow;">them</span> . </p>
<p><span style="background-color:yellow;">A</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">machine</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">usually</span> <span style="background-color:yellow;">works</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">making</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">mapping</span> <span style="background-color:yellow;">from</span> <span style="background-color:yellow;">integers</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">functions</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">either</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">switch</span> <span style="background-color:yellow;">statement</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">jump</span> <span style="background-color:yellow;">table</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>typedef int (*func_t)();

void run() {
    func_t table[] = {a, b, c};

    int state = 0;

    while(True) {
        state = table[state]();
    }
}
</code></pre>
<p><span style="background-color:yellow;">Alternatively</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">profile</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">try</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">find</span> <span style="background-color:yellow;">out</span> <span style="background-color:yellow;">why</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">slow.</span> <span style="background-color:yellow;">You</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">port</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">critical</span> <span style="background-color:yellow;">parts</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">C/C</span> <span style="background-color:yellow;">+</span> <span style="background-color:yellow;">+</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">keep</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">machine</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">3</span> </b><br /><p><span style="background-color:yellow;">The</span> <span style="background-color:yellow;">problem</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">Haskell</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">only</span> <span style="background-color:yellow;">introduces</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">synonym</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">quite</span> <span style="background-color:yellow;">similar</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">what</span> <span style="background-color:yellow;">typedef</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">does.</span> <span style="background-color:yellow;">One</span> <span style="background-color:yellow;">important</span> <span style="background-color:yellow;">restriction</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">expansion</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">must</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">finite</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">ca</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">give</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">finite</span> <span style="background-color:yellow;">expansion</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">machine.</span> <span style="background-color:yellow;">A</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">newtype</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">A</span> <span style="background-color:yellow;">newtype</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">wrapper</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">does</span> <span style="background-color:yellow;">only</span> <span style="background-color:yellow;">exist</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">checker</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">absolutely</span> <span style="background-color:yellow;">zero</span> <span style="background-color:yellow;">overhead</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">excluded</span> <span style="background-color:yellow;">stuff</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">occurs</span> <span style="background-color:yellow;">because</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">generalization</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">ca</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">removed</span> <span style="background-color:yellow;"></span> . <span style="background-color:yellow;">Here</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">signature</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">typechecks</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>newtype FN = FN { unFM :: (IO FN) }
</code></pre>
<p><span style="background-color:yellow;">Please</span> <span style="background-color:yellow;">note</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">whenever</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">FN</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">unpack</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">first</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">unFN</span> . <span style="background-color:yellow;">Whenever</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">return</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">new</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">FN</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">pack</span> <span style="background-color:yellow;">it</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">4</span> </b><br /><p><span style="background-color:yellow;">As</span> <span style="background-color:yellow;">usual</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">despite</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">great</span> <span style="background-color:yellow;">answers</span> <span style="background-color:yellow;">already</span> <span style="background-color:yellow;">present</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">resist</span> <span style="background-color:yellow;">trying</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">out</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">myself.</span> <span style="background-color:yellow;">One</span> <span style="background-color:yellow;">thing</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">bothered</span> <span style="background-color:yellow;">me</span> <span style="background-color:yellow;">about</span> <span style="background-color:yellow;">what</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">presented</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">ignores</span> <span style="background-color:yellow;">input.</span> <span style="background-color:yellow;">State</span> <span style="background-color:yellow;">machines--the</span> <span style="background-color:yellow;">ones</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">am</span> <span style="background-color:yellow;">familiar</span> <span style="background-color:yellow;">with--choose</span> <span style="background-color:yellow;">between</span> <span style="background-color:yellow;">various</span> <span style="background-color:yellow;">possible</span> <span style="background-color:yellow;">transitions</span> <span style="background-color:yellow;">based</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">input</span> . </p>
<pre><code>data State vocab = State { stateId :: String
                         , possibleInputs :: [vocab]
                         , _runTrans :: (vocab -> State vocab)
                         }
                      | GoalState { stateId :: String }

instance Show (State a) where
  show = stateId

runTransition :: Eq vocab => State vocab -> vocab -> Maybe (State vocab)
runTransition (GoalState id) _                   = Nothing
runTransition s x | x `notElem` possibleInputs s = Nothing
                  | otherwise                    = Just (_runTrans s x)
</code></pre>
<p><span style="background-color:yellow;">Here</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">define</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">State</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">parameterized</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">vocabulary</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">vocab</span> . <span style="background-color:yellow;">Now</span> <span style="background-color:yellow;">let</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">define</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">way</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">we</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">trace</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">execution</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">machine</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">feeding</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">inputs</span> . </p>
<pre><code>traceMachine :: (Show vocab, Eq vocab) => State vocab -> [vocab] -> IO ()
traceMachine _ [] = putStrLn "End of input"
traceMachine s (x:xs) = do
  putStrLn "Current state: "
  print s
  putStrLn "Current input: "
  print x
  putStrLn "-----------------------"
  case runTransition s x of
    Nothing -> putStrLn "Invalid transition"
    Just s' -> case s' of
      goal@(GoalState _) -> do
        putStrLn "Goal state reached:"
        print s'
        putStrLn "Input remaining:"
        print xs
      _ -> traceMachine s' xs
</code></pre>
<p><span style="background-color:yellow;">Now</span> <span style="background-color:yellow;">let</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">try</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">out</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">simple</span> <span style="background-color:yellow;">machine</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">ignores</span> <span style="background-color:yellow;">its</span> <span style="background-color:yellow;">inputs.</span> <span style="background-color:yellow;">Be</span> <span style="background-color:yellow;">warned</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">format</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">chosen</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">rather</span> <span style="background-color:yellow;">verbose.</span> <span style="background-color:yellow;">However</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">each</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">follows</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">viewed</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">node</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">machine</span> <span style="background-color:yellow;">diagram</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">think</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">'ll</span> <span style="background-color:yellow;">find</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">verbosity</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">completely</span> <span style="background-color:yellow;">relevant</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">describing</span> <span style="background-color:yellow;">such</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">node.</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'ve</span> <span style="background-color:yellow;">used</span> <span style="background-color:yellow;">stateId</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">encode</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">format</span> <span style="background-color:yellow;">some</span> <span style="background-color:yellow;">visual</span> <span style="background-color:yellow;">information</span> <span style="background-color:yellow;">about</span> <span style="background-color:yellow;">how</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">behaves</span> . </p>
<pre><code>data SimpleVocab = A | B | C deriving (Eq, Ord, Show, Enum)

simpleMachine :: State SimpleVocab
simpleMachine = stateA

stateA :: State SimpleVocab
stateA = State { stateId = "A state. * -> B"
               , possibleInputs = [A,B,C]
               , _runTrans = \_ -> stateB
               }

stateB :: State SimpleVocab
stateB = State { stateId = "B state. * -> C"
               , possibleInputs = [A,B,C]
               , _runTrans = \_ -> stateC
               }

stateC :: State SimpleVocab
stateC = State { stateId = "C state. * -> A"
               , possibleInputs = [A,B,C]
               , _runTrans = \_ -> stateA
               }
</code></pre>
<p><span style="background-color:yellow;">Since</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">inputs</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">matter</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">machine</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">feed</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">anything</span> . </p>
<pre><code>ghci> traceMachine simpleMachine [A,A,A,A]
</code></pre>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">wo</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">include</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">output</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">also</span> <span style="background-color:yellow;">very</span> <span style="background-color:yellow;">verbose</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">see</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">clearly</span> <span style="background-color:yellow;">moves</span> <span style="background-color:yellow;">from</span> <span style="background-color:yellow;">stateA</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">stateB</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">stateC</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">back</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">stateA</span> <span style="background-color:yellow;">again.</span> <span style="background-color:yellow;">Now</span> <span style="background-color:yellow;">let</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">make</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">slightly</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">complicated</span> <span style="background-color:yellow;">machine</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>lessSimpleMachine :: State SimpleVocab
lessSimpleMachine = startNode

startNode :: State SimpleVocab
startNode = State { stateId = "Start node. A -> 1, C -> 2"
                  , possibleInputs = [A,C]
                  , _runTrans = startNodeTrans
                  }
  where startNodeTrans C = node2
        startNodeTrans A = node1

node1 :: State SimpleVocab
node1 = State { stateId = "node1. B -> start, A -> goal"
              , possibleInputs = [B, A]
              , _runTrans = node1trans
              }
  where node1trans B = startNode
        node1trans A = goalNode

node2 :: State SimpleVocab
node2 = State { stateId = "node2. C -> goal, A -> 1, B -> 2"
              , possibleInputs = [A,B,C]
              , _runTrans = node2trans
              }
  where node2trans A = node1
        node2trans B = node2
        node2trans C = goalNode

goalNode :: State SimpleVocab
goalNode = GoalState "Goal. :)"
</code></pre>
<p><span style="background-color:yellow;">The</span> <span style="background-color:yellow;">possible</span> <span style="background-color:yellow;">inputs</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">transitions</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">each</span> <span style="background-color:yellow;">node</span> <span style="background-color:yellow;">should</span> <span style="background-color:yellow;">require</span> <span style="background-color:yellow;">no</span> <span style="background-color:yellow;">further</span> <span style="background-color:yellow;">explanation</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">they</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">verbosely</span> <span style="background-color:yellow;">described</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">code.</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'ll</span> <span style="background-color:yellow;">let</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">play</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">traceMachine</span> <span style="background-color:yellow;">lessSipmleMachine</span> <span style="background-color:yellow;">inputs</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">yourself.</span> <span style="background-color:yellow;">See</span> <span style="background-color:yellow;">what</span> <span style="background-color:yellow;">happens</span> <span style="background-color:yellow;">when</span> <span style="background-color:yellow;">inputs</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">invalid</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">does</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">adhere</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">possible</span> <span style="background-color:yellow;">inputs</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">restrictions</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">when</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">hit</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">goal</span> <span style="background-color:yellow;">node</span> <span style="background-color:yellow;">before</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">end</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">input</span> . </p>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">suppose</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">verbosity</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;">sort</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">fails</span> <span style="background-color:yellow;">what</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">were</span> <span style="background-color:yellow;">basically</span> <span style="background-color:yellow;">asking</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">was</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">cut</span> <span style="background-color:yellow;">down</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">cruft.</span> <span style="background-color:yellow;">But</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">think</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">also</span> <span style="background-color:yellow;">illustrates</span> <span style="background-color:yellow;">how</span> <span style="background-color:yellow;">descriptive</span> <span style="background-color:yellow;">Haskell</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">be.</span> <span style="background-color:yellow;">Even</span> <span style="background-color:yellow;">though</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">very</span> <span style="background-color:yellow;">verbose</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">also</span> <span style="background-color:yellow;">very</span> <span style="background-color:yellow;">straightforward</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">how</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">represents</span> <span style="background-color:yellow;">nodes</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">machine</span> <span style="background-color:yellow;">diagram</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">5</span> </b><br /><p><span style="background-color:yellow;">Your</span> <span style="background-color:yellow;">problem</span> <span style="background-color:yellow;">has</span> <span style="background-color:yellow;">been</span> <span style="background-color:yellow;">had</span> <span style="background-color:yellow;">before</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">Recursive</span> <span style="background-color:yellow;">declaration</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">pointer</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">C</span> </p>
<p><span style="background-color:yellow;">C</span> <span style="background-color:yellow;">+</span> <span style="background-color:yellow;">+</span> <span style="background-color:yellow;">operator</span> <span style="background-color:yellow;">overloading</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">used</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">hide</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">mechanics</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">what</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">essentially</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">same</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">Haskell</span> <span style="background-color:yellow;">solutions</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">Herb</span> <span style="background-color:yellow;">Sutter</span> <span style="background-color:yellow;">describes</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">GotW</span> <span style="background-color:yellow;">#</span> <span style="background-color:yellow;">57</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">Recursive</span> <span style="background-color:yellow;">Declarations</span> . </p>
<pre><code>struct FuncPtr_;
typedef FuncPtr_ (*FuncPtr)();

struct FuncPtr_
{
  FuncPtr_( FuncPtr pp ) : p( pp ) { }
  operator FuncPtr() { return p; }
  FuncPtr p;
};

FuncPtr_ f() { return f; } // natural return syntax

int main()
{
  FuncPtr p = f();  // natural usage syntax
  p();
}
</code></pre>
<p><span style="background-color:yellow;">But</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">business</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">functions</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">likelihood</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">perform</span> <span style="background-color:yellow;">worse</span> <span style="background-color:yellow;">than</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">equivalent</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">numeric</span> <span style="background-color:yellow;">states.</span> <span style="background-color:yellow;">You</span> <span style="background-color:yellow;">should</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">switch</span> <span style="background-color:yellow;">statement</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">table</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">because</span> <span style="background-color:yellow;">what</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">really</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">situation</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">structured</span> <span style="background-color:yellow;">semantic</span> <span style="background-color:yellow;">equivalent</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">goto</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">6</span> </b><br /><p><span style="background-color:yellow;">You</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">get</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">same</span> <span style="background-color:yellow;">effect</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">code,-</span> <span style="background-color:yellow;">just</span> <span style="background-color:yellow;">declare</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">functions</span> <span style="background-color:yellow;">returns</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">void</span> <span style="background-color:yellow;">*</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">:</span> </p>
<pre><code>#include "stdio.h"

typedef void* (*myFunc)(void);

void* a(void);
void* b(void);
void* c(void);

void* a(void) {
  printf("a()\n");
  return b;
}

void* b(void) {
  printf("b()\n");
  return c;
}

void* c(void) {
  printf("c()\n");
  return a;
}

void main() {
 void* state = a;
 while (1) {
   state = ((myFunc)state)();
   sleep(1);
 }
}
</code></pre>
<p><span style="background-color:yellow;">HTH</span> <span style="background-color:yellow;">!</span> </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">7</span> </b><br /><p><span style="background-color:yellow;">What</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">recursive</span> <span style="background-color:yellow;">type.</span> <span style="background-color:yellow;">Different</span> <span style="background-color:yellow;">languages</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">different</span> <span style="background-color:yellow;">ways</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">doing</span> <span style="background-color:yellow;">this</span> . </p>
<p><span style="background-color:yellow;">For</span> <span style="background-color:yellow;">example</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">OCaml</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">statically-typed</span> <span style="background-color:yellow;">language</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">optional</span> <span style="background-color:yellow;">compiler/interpreter</span> <span style="background-color:yellow;">flag</span> <span style="background-color:yellow;">-rectypes</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">enables</span> <span style="background-color:yellow;">support</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">recursive</span> <span style="background-color:yellow;">types</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">allowing</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">define</span> <span style="background-color:yellow;">stuff</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>let rec a () = print_endline "a()"; b
and b () = print_endline "b()"; c
and c () = print_endline "c()"; a
;;
</code></pre>
<p><span style="background-color:yellow;">Although</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">ugly</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">complained</span> <span style="background-color:yellow;">about</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">example</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">what</span> <span style="background-color:yellow;">happens</span> <span style="background-color:yellow;">underneath</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">still</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">same.</span> <span style="background-color:yellow;">The</span> <span style="background-color:yellow;">compiler</span> <span style="background-color:yellow;">simply</span> <span style="background-color:yellow;">worries</span> <span style="background-color:yellow;">about</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">instead</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">forcing</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">write</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">out</span> . </p>
<p><span style="background-color:yellow;">As</span> <span style="background-color:yellow;">others</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">pointed</span> <span style="background-color:yellow;">out</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">Haskell</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">newtype</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">wo</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">any</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">overhead</span> <span style="background-color:yellow;">"</span> . <span style="background-color:yellow;">But</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">complain</span> <span style="background-color:yellow;">about</span> <span style="background-color:yellow;">having</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">explicitly</span> <span style="background-color:yellow;">wrap</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">unwrap</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">recursive</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">ugly</span> <span style="background-color:yellow;">"</span> . <span style="background-color:yellow;"></span> <span style="background-color:yellow;">Similarly</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">example</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">no</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">overhead</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">since</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">machine</span> <span style="background-color:yellow;">level</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">1-member</span> <span style="background-color:yellow;">struct</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">identical</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">its</span> <span style="background-color:yellow;">member</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">ugly</span> <span style="background-color:yellow;">"</span> . <span style="background-color:yellow;"></span> </p>
<p><span style="background-color:yellow;">Another</span> <span style="background-color:yellow;">example</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">mention</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">Go</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">another</span> <span style="background-color:yellow;">statically-typed</span> <span style="background-color:yellow;">language</span> <span style="background-color:yellow;"></span> . <span style="background-color:yellow;">In</span> <span style="background-color:yellow;">Go</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">construct</span> <span style="background-color:yellow;">defines</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">new</span> <span style="background-color:yellow;">type.</span> <span style="background-color:yellow;">It</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">simple</span> <span style="background-color:yellow;">alias</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">typedef</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">Haskell</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">creates</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">full-fledged</span> <span style="background-color:yellow;">new</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">newtype</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">Haskell</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">because</span> <span style="background-color:yellow;">such</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">has</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">independent</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">method</span> <span style="background-color:yellow;">set</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">methods</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">define</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">it.</span> <span style="background-color:yellow;">Because</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">definition</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">recursive</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>type Fn func () Fn
</code></pre>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">8</span> </b><br /><p><span style="background-color:yellow;">Iit</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">hard</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">make</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">machines</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">Haskell</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">once</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">realize</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">they</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">monads</span> <span style="background-color:yellow;">!</span> <span style="background-color:yellow;">A</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">machine</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">one</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">arrow</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">automaton</span> <span style="background-color:yellow;">arrow</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">exact</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>newtype State a b = State (a -> (b, State a b))
</code></pre>
<p><span style="background-color:yellow;">This</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">takes</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">input</span> <span style="background-color:yellow;">value</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">produces</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">output</span> <span style="background-color:yellow;">value</span> <span style="background-color:yellow;">along</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">new</span> <span style="background-color:yellow;">version</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">itself.</span> <span style="background-color:yellow;">This</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">monad</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">because</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">write</span> <span style="background-color:yellow;">join</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">&gt</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">&gt</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">=</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">it.</span> <span style="background-color:yellow;">Equivalently</span> <span style="background-color:yellow;">once</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">turned</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">into</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">arrow</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">realize</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">impossible</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">write</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">ArrowApply</span> <span style="background-color:yellow;">instance</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">it</span> . </p>
<p><span style="background-color:yellow;">Here</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">instances</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>import Control.Arrow
import Control.Category
import Prelude hiding ((.), id)

instance Category State where
    id = State $ \x -> (x, id)

    State f . State g =
        State $ \x ->
            let (y, s2) = g x
                (z, s1) = f y
            in (z, s1 . s2)

instance Arrow State where
    arr f = let s = State $ \x -> (f x, s) in s
    first (State f) =
        State $ \(x1, x2) ->
            let (y1, s) = f x1
            in ((y1, x2), first s)
</code></pre>
<p><span style="background-color:yellow;">Have</span> <span style="background-color:yellow;">fun</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">9</span> </b><br /><p><span style="background-color:yellow;">An</span> <span style="background-color:yellow;">example</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">F</span> <span style="background-color:yellow;">#</span> <span style="background-color:yellow;">:</span> </p>
<pre>
type Cont = Cont of (unit -> Cont)

let rec a() =
    printfn "a()"
    Cont (fun () -> b 42)

and b n =
    printfn "b(%d)" n
    Cont c

and c() =
    printfn "c()"
    Cont a

let rec run (Cont f) =
    let f = f()
    run f

run (Cont a)
</pre>
<p><span style="background-color:yellow;">Regarding</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">question</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">why</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">hard</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">implement</span> <span style="background-color:yellow;">state</span> <span style="background-color:yellow;">machines</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">functions</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">statically</span> <span style="background-color:yellow;">typed</span> <span style="background-color:yellow;">languages</span> ? <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">That</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">because</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">friends</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">little</span> <span style="background-color:yellow;">bit</span> <span style="background-color:yellow;">weird</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">when</span> <span style="background-color:yellow;">returns</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">returns</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">returns</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">function..</span> . </p>
<p><span style="background-color:yellow;">If</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">remove</span> <span style="background-color:yellow;">Cont</span> <span style="background-color:yellow;">from</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">example</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">F</span> <span style="background-color:yellow;">#</span> <span style="background-color:yellow;">compiler</span> <span style="background-color:yellow;">complains</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">says</span> <span style="background-color:yellow;">:</span> </p>
<pre>
Expecting 'a but given unit -> 'a. The resulting type would be infinite when unifying 'a and unit -> 'a.
</pre>
<p><span style="background-color:yellow;">Another</span> <span style="background-color:yellow;">answer</span> <span style="background-color:yellow;">shows</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">OCaml</span> <span style="background-color:yellow;">whose</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">inference</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">strong</span> <span style="background-color:yellow;">enough</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">remove</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">need</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">declaring</span> <span style="background-color:yellow;">Cont</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">shows</span> <span style="background-color:yellow;">static</span> <span style="background-color:yellow;">typing</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">blame</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">rather</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">lack</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">powerful</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">inference</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">many</span> <span style="background-color:yellow;">statically</span> <span style="background-color:yellow;">typed</span> <span style="background-color:yellow;">languages</span> . </p>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">know</span> <span style="background-color:yellow;">why</span> <span style="background-color:yellow;">F</span> <span style="background-color:yellow;">#</span> <span style="background-color:yellow;">does</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">would</span> <span style="background-color:yellow;">guess</span> <span style="background-color:yellow;">maybe</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">would</span> <span style="background-color:yellow;">make</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">inference</span> <span style="background-color:yellow;">algorithm</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">complicated</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">slower</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">too</span> <span style="background-color:yellow;">powerful</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">manage</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">infer</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">type</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">incorrectly</span> <span style="background-color:yellow;">typed</span> <span style="background-color:yellow;">expressions</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">failing</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">later</span> <span style="background-color:yellow;">point</span> <span style="background-color:yellow;">giving</span> <span style="background-color:yellow;">error</span> <span style="background-color:yellow;">messages</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">hard</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">understand</span> <span style="background-color:yellow;"></span> . </p>
<p><span style="background-color:yellow;">Note</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">example</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">gave</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">really</span> <span style="background-color:yellow;">safe.</span> <span style="background-color:yellow;">In</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">example</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">b</span> <span style="background-color:yellow;">represents</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">family</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">states</span> <span style="background-color:yellow;">parameterized</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">integer.</span> <span style="background-color:yellow;">In</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">untyped</span> <span style="background-color:yellow;">language</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">easy</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">make</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">mistake</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">return</span> <span style="background-color:yellow;">b</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">b</span> <span style="background-color:yellow;">42</span> <span style="background-color:yellow;">instead</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">correct</span> <span style="background-color:yellow;">lambda</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">miss</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">mistake</span> <span style="background-color:yellow;">until</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">executed</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">10</span> </b><br /><p><span style="background-color:yellow;">The</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">posted</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">transformed</span> <span style="background-color:yellow;">into</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">recursive</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">tail</span> <span style="background-color:yellow;">call</span> <span style="background-color:yellow;">optimized</span> <span style="background-color:yellow;">because</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">has</span> <span style="background-color:yellow;">no</span> <span style="background-color:yellow;">tail</span> <span style="background-color:yellow;">call</span> <span style="background-color:yellow;">optimization</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">stack</span> <span style="background-color:yellow;">overflow</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">some</span> <span style="background-color:yellow;">point.</span> <span style="background-color:yellow;">So</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">actually</span> <span style="background-color:yellow;">broken</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">would</span> <span style="background-color:yellow;">take</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">work</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">get</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">good</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">Haskell</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">versions</span> . </p>
<p><span style="background-color:yellow;">Here</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">example</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">what</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">mean</span> <span style="background-color:yellow;">:</span> </p>
<p><span style="background-color:yellow;">so.py</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>import threading
stack_size_bytes = 10**5
threading.stack_size(10**5)
machine_word_size = 4

def t1():
    print "start t1"
    n = stack_size_bytes/machine_word_size
    while n:
        n -= 1
    print "done t1"

def t2():
    print "start t2"
    n = stack_size_bytes/machine_word_size+1
    while n:
        n -= 1
    print "done t2"

if __name__ == "__main__":
    t = threading.Thread(target=t1)
    t.start()
    t.join()
    t = threading.Thread(target=t2)
    t.start()
    t.join()
</code></pre>
<p><span style="background-color:yellow;">shell</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>$ python so.py
start t1
done t1
start t2
Exception in thread Thread-2:
Traceback (most recent call last):
  File "/usr/lib/python2.7/threading.py", line 530, in __bootstrap_inner
    self.run()
  File "/usr/lib/python2.7/threading.py", line 483, in run
    self.__target(*self.__args, **self.__kwargs)
  File "so.py", line 18, in t2
    print "done t2"
RuntimeError: maximum recursion depth exceeded
</code></pre>
<br />