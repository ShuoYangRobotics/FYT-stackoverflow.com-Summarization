<h3><span style="background-color:yellow;">Question</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">ID-5010631</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">:</span> </h3><h2><span style="background-color:yellow;">"</span> <span style="background-color:yellow;">Counting</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">multiple</span> <span style="background-color:yellow;">regular</span> <span style="background-color:yellow;">expressions</span> <span style="background-color:yellow;">matches</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">Python</span> </h2><p><span style="background-color:yellow;">Let</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">say</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">following</span> <span style="background-color:yellow;">multi-line</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">:</span> </p>
<pre><code># Section
## Subsection
## Subsection
# Section
## Subsection
### Subsubsection
### Subsubsection
# Section
## Subsection
</code></pre>
<p><span style="background-color:yellow;">and</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">become</span> <span style="background-color:yellow;">:</span> </p>
<pre><code># 1 Section
## 1.1 Subsection
## 1.2 Subsection
# 2 Section
## 2.1 Subsection
### 2.1.1 Subsubsection
### 2.1.2 Subsubsection
# 3 Section
## 3.1 Subsection
</code></pre>
<p><span style="background-color:yellow;">In</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">re</span> <span style="background-color:yellow;">module</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">possible</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">run</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">substitution</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">would</span> <span style="background-color:yellow;">:</span> </p>
<ul><span style="background-color:yellow;">Match</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">beginning</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">each</span> <span style="background-color:yellow;">line</span> <span style="background-color:yellow;">based</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">number</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">#</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">Keep</span> <span style="background-color:yellow;">track</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">past</span> <span style="background-color:yellow;">matches</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">commonly-numbered</span> <span style="background-color:yellow;">groups</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">#</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">Insert</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">counter</span> <span style="background-color:yellow;">when</span> <span style="background-color:yellow;">appropriate</span> <span style="background-color:yellow;">into</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">line</span> </ul>
<p><span style="background-color:yellow;">...assuming</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">any</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">these</span> <span style="background-color:yellow;">'counters</span> <span style="background-color:yellow;">'</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">always</span> <span style="background-color:yellow;">non-zero</span> ? </p>
<p><span style="background-color:yellow;">This</span> <span style="background-color:yellow;">problem</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">testing</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">limits</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">regex</span> <span style="background-color:yellow;">knowledge.</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">already</span> <span style="background-color:yellow;">know</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">just</span> <span style="background-color:yellow;">iterate</span> <span style="background-color:yellow;">over</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">lines</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">increment/insert</span> <span style="background-color:yellow;">some</span> <span style="background-color:yellow;">variables</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">want.</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'m</span> <span style="background-color:yellow;">simply</span> <span style="background-color:yellow;">curious</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">kind</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">functionality</span> <span style="background-color:yellow;">exists</span> <span style="background-color:yellow;">solely</span> <span style="background-color:yellow;">within</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">regular</span> <span style="background-color:yellow;">expressions</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">know</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">some</span> <span style="background-color:yellow;">sort</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">counting</span> <span style="background-color:yellow;">already</span> <span style="background-color:yellow;">exists</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">e.g.</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">number</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">substitutions</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">make</span> <span style="background-color:yellow;"></span> . </p>
<br /><h3><span style="background-color:yellow;">Answers</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">Total-6</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">:</span> </h3><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">0</span> </b><br /><p>« <em>Ok, sure, but what if the 'variable manipulation' is being done in a callback function of re.sub, can it be done then? I guess a simplified form of my question is: "Can one use regular expressions to substitue differently based on previous matches?"</em> »</p>
<p><span style="background-color:yellow;">It</span> <span style="background-color:yellow;">sounds</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">we</span> <span style="background-color:yellow;">need</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">generator</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">callback</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">unfortunately</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">re.sub</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">does</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">accept</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">generator</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">callback</span> . </p>
<p><span style="background-color:yellow;">So</span> <span style="background-color:yellow;">we</span> <span style="background-color:yellow;">must</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">some</span> <span style="background-color:yellow;">trick</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>import re

pat = re.compile('^(#+)',re.MULTILINE)

ch = '''# Section
## Subsection
## Subsection
# Section
## Subsection
### Subsubsection
### Subsubsection
## Subsection
### Subsubsection
### Subsubsection
#### Sub4section
#### Sub4section
#### Sub4section
#### Sub4section
##### Sub5section
#### Sub4section
##### Sub5section
##### Sub5section
### Subsubsection
### Subsubsection
#### Sub4section
#### Sub4section
## Subsection
### Subsubsection
### Subsubsection
### Subsubsection
#### Sub4section
##### Sub5section
##### Sub5section
### Subsubsection
#### Sub4section
## Subsection
### Subsubsection
### Subsubsection
# Section
## Subsection
## Subsection
# Section
## Subsection
### Subsubsection
#### Sub4section
#### Sub4section
#### Sub4section
##### Sub5section
#### Sub4section
### Subsubsection
## Subsection
### Subsubsection
# Section
## Subsection
'''

def cbk(match, nb = [0] ):
    if len(match.group())==len(nb):
        nb[-1] += 1
    elif  len(match.group())>len(nb):
        nb.append(1)
    else:
        nb[:] = nb[0:len(match.group())]
        nb[-1] += 1
    return match.group()+' '+('.'.join(map(str,nb)))

ch = pat.sub(cbk,ch)
print ch
</code></pre>
<p>. </p>
<p>« Default parameter values are evaluated when the function definition is executed. This means that the expression is evaluated once, when the function is defined, and that that same “pre-computed” value is used for each call. This is especially important to understand <strong>when a default parameter is a mutable object,</strong> such as a list or a dictionary: <strong>if the function modifies the object</strong> (e.g. by appending an item to a list), <strong>the default value is in effect modified.</strong> This is generally not what was intended. »</p>
<p><span style="background-color:yellow;">http</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">//docs.python.org/reference/compound_stmts.html</span> <span style="background-color:yellow;">#</span> <span style="background-color:yellow;">function</span> </p>
<p><span style="background-color:yellow;">But</span> <span style="background-color:yellow;">here</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">IS</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">plain</span> <span style="background-color:yellow;">intent</span> . </p>
<p><span style="background-color:yellow;">Result</span> <span style="background-color:yellow;">:</span> </p>
<pre><code># 1 Section
## 1.1 Subsection
## 1.2 Subsection
# 2 Section
## 2.1 Subsection
### 2.1.1 Subsubsection
### 2.1.2 Subsubsection
## 2.2 Subsection
### 2.2.1 Subsubsection
### 2.2.2 Subsubsection
#### 2.2.2.1 Sub4section
#### 2.2.2.2 Sub4section
#### 2.2.2.3 Sub4section
#### 2.2.2.4 Sub4section
##### 2.2.2.4.1 Sub5section
#### 2.2.2.5 Sub4section
##### 2.2.2.5.1 Sub5section
##### 2.2.2.5.2 Sub5section
### 2.2.3 Subsubsection
### 2.2.4 Subsubsection
#### 2.2.4.1 Sub4section
#### 2.2.4.2 Sub4section
## 2.3 Subsection
### 2.3.1 Subsubsection
### 2.3.2 Subsubsection
### 2.3.3 Subsubsection
#### 2.3.3.1 Sub4section
##### 2.3.3.1.1 Sub5section
##### 2.3.3.1.2 Sub5section
### 2.3.4 Subsubsection
#### 2.3.4.1 Sub4section
## 2.4 Subsection
### 2.4.1 Subsubsection
### 2.4.2 Subsubsection
# 3 Section
## 3.1 Subsection
## 3.2 Subsection
# 4 Section
## 4.1 Subsection
### 4.1.1 Subsubsection
#### 4.1.1.1 Sub4section
#### 4.1.1.2 Sub4section
#### 4.1.1.3 Sub4section
##### 4.1.1.3.1 Sub5section
#### 4.1.1.4 Sub4section
### 4.1.2 Subsubsection
## 4.2 Subsection
### 4.2.1 Subsubsection
# 5 Section
## 5.1 Subsection
</code></pre>
<p><span style="background-color:yellow;">EDIT</span> <span style="background-color:yellow;">1</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">corrected</span> <span style="background-color:yellow;">else</span> <span style="background-color:yellow;">nb</span> <span style="background-color:yellow;">[</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">]</span> <span style="background-color:yellow;">=</span> <span style="background-color:yellow;">nb</span> <span style="background-color:yellow;">[</span> <span style="background-color:yellow;">0</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">len</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">match.group</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">]</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">else</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">only</span> </p>
<p><span style="background-color:yellow;">EDIT</span> <span style="background-color:yellow;">2</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">condensed</span> <span style="background-color:yellow;">to</span> </p>
<pre><code>def cbk(match, nb = [0] ):
    if len(match.group())>len(nb):
        nb.append(1)
    else:
        nb[:] = nb[0:len(match.group())]
        nb[-1] += 1
    return match.group()+' '+('.'.join(map(str,nb))) 
</code></pre>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">1</span> </b><br /><p><span style="background-color:yellow;">Regular</span> <span style="background-color:yellow;">expressions</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">matching</span> <span style="background-color:yellow;">strings.</span> <span style="background-color:yellow;">They</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">manipulating</span> <span style="background-color:yellow;">variables</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">matching</span> <span style="background-color:yellow;">occurs.</span> <span style="background-color:yellow;">You</span> <span style="background-color:yellow;">may</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">iterating</span> <span style="background-color:yellow;">over</span> <span style="background-color:yellow;">each</span> <span style="background-color:yellow;">line</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">counting</span> <span style="background-color:yellow;">yourself</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">straightforward</span> <span style="background-color:yellow;">solution</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">2</span> </b><br /><p><span style="background-color:yellow;">Pyparsing</span> <span style="background-color:yellow;">packages</span> <span style="background-color:yellow;">several</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">these</span> <span style="background-color:yellow;">scan/match/replace</span> <span style="background-color:yellow;">tasks</span> <span style="background-color:yellow;">up</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">into</span> <span style="background-color:yellow;">its</span> <span style="background-color:yellow;">own</span> <span style="background-color:yellow;">parsing</span> <span style="background-color:yellow;">framework.</span> <span style="background-color:yellow;">Here</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">annotated</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">stated</span> <span style="background-color:yellow;">problem</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>from pyparsing import LineStart, Word, restOfLine

source = """\
# Section 
## Subsection 
## Subsection 
# Section 
## Subsection #
### Subsubsection 
### Subsubsection 
# Section 
## Subsection 
"""

# define a pyparsing expression to match a header line starting with some 
# number of '#'s (i.e., a "word" composed of '#'s), followed by the rest 
# of the line
sectionHeader = LineStart() + Word("#")("level") + restOfLine

# define a callback to keep track of the nesting and numbering
numberstack = [0]
def insertDottedNumber(tokens):
    level = len(tokens.level)
    if level > len(numberstack):
        numberstack.extend([1]*(level-len(numberstack)))
    else:
        del numberstack[level:]
        numberstack[level-1] += 1

    dottedNum = '.'.join(map(str,numberstack))

    # return the updated string containing the original level and rest
    # of the line, with the dotted number inserted
    return "%s %s %s" % (tokens.level, dottedNum, tokens[1])

# attach parse-time action callback to the sectionHeader expression
sectionHeader.setParseAction(insertDottedNumber)

# use sectionHeader expression to transform the input source string
newsource = sectionHeader.transformString(source)
print newsource
</code></pre>
<p><span style="background-color:yellow;">Prints</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">desired</span> <span style="background-color:yellow;">:</span> </p>
<pre><code># 1  Section 
## 1.1  Subsection 
## 1.2  Subsection 
# 2  Section 
## 2.1  Subsection #
### 2.1.1  Subsubsection 
### 2.1.2  Subsubsection 
# 3  Section 
## 3.1  Subsection 
</code></pre>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">3</span> </b><br /><p><span style="background-color:yellow;">This</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">job</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">regular</span> <span style="background-color:yellow;">expressions</span> <span style="background-color:yellow;">alone</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">may</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">able</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">them</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">make</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">job</span> <span style="background-color:yellow;">easier.</span> <span style="background-color:yellow;">For</span> <span style="background-color:yellow;">example</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">splits</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">full</span> <span style="background-color:yellow;">text</span> <span style="background-color:yellow;">into</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">major</span> <span style="background-color:yellow;">sections</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">regular</span> <span style="background-color:yellow;">expressions</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>>>> p = re.compile(r"^# .*\n^(?:^##.*\n)*", re.M)
>>> p.findall(your_text)
['# Section\n## Subsection\n## Subsection\n', '# Section\n## Subsection\n### Subsubsection\n### Subsubsection\n', '# Section\n']
</code></pre>
<p><span style="background-color:yellow;">You</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">conceivably</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">something</span> <span style="background-color:yellow;">recursive</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">regular</span> <span style="background-color:yellow;">expression</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">further</span> <span style="background-color:yellow;">split</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">subsections</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">much</span> <span style="background-color:yellow;">better</span> <span style="background-color:yellow;">off</span> <span style="background-color:yellow;">just</span> <span style="background-color:yellow;">looping</span> <span style="background-color:yellow;">through</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">lines</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">4</span> </b><br /><pre><code>import re
import textwrap

class DefaultList(list):
    """
    List having a default value (returned on invalid offset)

    >>> t = DefaultList([1,2,3], default=17)
    >>> t[104]
    17
    """
    def __init__(self, *args, **kwargs):
        self.default = kwargs.pop('default', None)
        super(DefaultList,self).__init__(*args, **kwargs)

    def __getitem__(self, y):
        if y >= self.__len__():
            return self.default
        else:
            return super(DefaultList,self).__getitem__(y)

class SectionNumberer(object):
    "Hierarchical document numberer"
    def __init__(self, LineMatcher, Numbertype_list, defaultNumbertype):
        """
        @param LineMatcher:       line matcher instance  (recognize section headings and parse them)
        @param Numbertype_list:   list of Number classes (do section numbering at each level)
        @param defaultNumbertype: default Number class   (if too few Number classes specified)
        """
        super(SectionNumberer,self).__init__()
        self.match   = LineMatcher
        self.types   = DefaultList(Numbertype_list, default=defaultNumbertype)
        self.numbers = []
        self.title   = ''

    def addSection(self, level, title):
        "Add new section"
        depth = len(self.numbers)
        if depth < level:
            for i in range(depth, level):
                self.numbers.append(self.types[i](1))
        else:
            self.numbers = self.numbers[:level]
            self.numbers[-1].inc()

        self.title = title

    def doLine(self, ln):
        "Process section numbering on single-line string"
        match = self.match(ln)
        if match==False:
            return ln
        else:
            self.addSection(*match)
            return str(self)

    def __call__(self, s):
        "Process section numbering on multiline string"
        return '\n'.join(self.doLine(ln) for ln in s.split('\n'))

    def __str__(self):
        "Get label for current section"
        section = '.'.join(str(n) for n in self.numbers)
        return "{0} {1}".format(section, self.title)

class LineMatcher(object):
    "Recognize section headers and parse them"
    def __init__(self, match):
        super(LineMatcher,self).__init__()
        self.match = re.compile(match)

    def __call__(self, line):
        """
        @param line: string

        Expects that self.match is a valid regex expression
        """
        match = re.match(self.match, line)
        if match:
            return len(match.group(1)), match.group(2)
        else:
            return False

# Recognize section headers that look like '### Section_title'
PoundLineMatcher = lambda: LineMatcher(r'([#]+) (.*)')

class Numbertype(object):
    def __init__(self, startAt=0, valueType=int):
        super(Numbertype,self).__init__()
        self.value = valueType(startAt)

    def inc(self):
        self.value += 1

    def __str__(self):
        return str(self.value)

class Roman(int):
    CODING = [
        (1000, 'M'),
        ( 900, 'CM'), ( 500, 'D'), ( 400, 'CD'), ( 100, 'C'),
        (  90, 'XC'), (  50, 'L'), (  40, 'XL'), (  10, 'X'),
        (   9, 'IX'), (   5, 'V'), (   4, 'IV'), (   1, 'I')
    ]

    def __add__(self, y):
        return Roman(int.__add__(self, y))

    def __str__(self):
        value = self.__int__()
        if 0 < value < 4000:
            result = []
            for v,s in Roman.CODING:
                while v <= value:
                    value -= v
                    result.append(s)
            return ''.join(result)
        else:
            raise ValueError("can't generate Roman numeral string for {0}".format(value))

IntNumber = Numbertype
RomanNumber = lambda x=1: Numbertype(x, Roman)

def main():
    test = textwrap.dedent("""
        # Section
        ## Subsection
        ## Subsection
        # Section
        ## Subsection
        ### Subsubsection
        ### Subsubsection
        # Section
        ## Subsection
    """)

    numberer = SectionNumberer(PoundLineMatcher(), [IntNumber, RomanNumber, IntNumber], IntNumber)
    print numberer(test)

if __name__=="__main__":
    main()
</code></pre>
<p><span style="background-color:yellow;">turns</span> </p>
<pre><code># Section
## Subsection
## Subsection
# Section
## Subsection
### Subsubsection
### Subsubsection
# Section
## Subsection
</code></pre>
<p><span style="background-color:yellow;">into</span> </p>
<pre><code>1 Section
1.I Subsection
1.II Subsection
2 Section
2.I Subsection
2.I.1 Subsubsection
2.I.2 Subsubsection
3 Section
3.I Subsection
</code></pre>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">5</span> </b><br /><p><span style="background-color:yellow;">Use</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">generator</span> <span style="background-color:yellow;">trick</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">eyquem.</span> <span style="background-color:yellow;">If</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">always</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">find</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">global</span> <span style="background-color:yellow;">context</span> <span style="background-color:yellow;">then</span> <span style="background-color:yellow;">rewrite</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">stuff</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">new</span> <span style="background-color:yellow;">buffer</span> . </p>
<p><span style="background-color:yellow;">If</span> <span style="background-color:yellow;">its</span> <span style="background-color:yellow;">just</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">one</span> <span style="background-color:yellow;">off</span> <span style="background-color:yellow;">thing</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">Perl</span> <span style="background-color:yellow;">sample</span> <span style="background-color:yellow;">does</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">all..</span> . </p>
<pre><code>use strict;
use warnings;

my $data = '
 # 
 ## 
 ## 
 # 
 ## 
 ### 
 ### 
 ###### 
 ##### 
 ####  
 ##### 
 #### 
 ##### 
 ###### 
 ##### 
 ## 
 # 
 ## 
 ';

my @cnts = ();

$data =~ s/^ [^\S\n]* (\#+) [^\S\n]* (.*) $/ callback($1,$2) /xemg;

print $data;

exit(0);

##
 sub callback {
    my ($pounds, $text) = @_;
    my $i = length($pounds) - 1;
    if ($i == 0 || $i <= $#cnts) {
        @cnts[ ($i+1) .. $#cnts ] = (0) x ($#cnts - $i);
        ++$cnts[ $i ];
    }
    else {
        @cnts[ ($#cnts+1) .. $i ] = (1) x ($i - $#cnts);
    }
    my $chapter = $cnts[0];
    for my $ndx (1 .. $i) {
        $chapter .= ".$cnts[ $ndx]";
    }
    return "$pounds \t $chapter $text";
 }
</code></pre>
<p><span style="background-color:yellow;">Output</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>#        1
##       1.1
##       1.2
#        2
##       2.1
###      2.1.1
###      2.1.2
######   2.1.2.1.1.1
#####    2.1.2.1.2
####     2.1.2.2
#####    2.1.2.2.1
####     2.1.2.3
#####    2.1.2.3.1
######   2.1.2.3.1.1
#####    2.1.2.3.2
##       2.2
#        3
##       3.1
</code></pre>
<p><span style="background-color:yellow;">My</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">helpfull</span> <span style="background-color:yellow;">people</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">SO</span> </p>
<br />