<h3><span style="background-color:yellow;">Question</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">ID-1042900</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">:</span> </h3><h2><span style="background-color:yellow;">Django</span> <span style="background-color:yellow;">unit</span> <span style="background-color:yellow;">testing</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">date/time-based</span> <span style="background-color:yellow;">objects</span> </h2><p><span style="background-color:yellow;">Suppose</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">following</span> <span style="background-color:yellow;">Event</span> <span style="background-color:yellow;">model</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>from django.db import models
import datetime

class Event(models.Model):
    date_start = models.DateField()
    date_end = models.DateField()

    def is_over(self):
        return datetime.date.today() > self.date_end
</code></pre>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">test</span> <span style="background-color:yellow;">Event.is_over</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">creating</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">Event</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">ends</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">future</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">today</span> <span style="background-color:yellow;">+</span> <span style="background-color:yellow;">1</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">something</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">stubbing</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">date</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">time</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">system</span> <span style="background-color:yellow;">thinks</span> <span style="background-color:yellow;">we</span> <span style="background-color:yellow;">'ve</span> <span style="background-color:yellow;">reached</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">future</span> <span style="background-color:yellow;">date</span> . </p>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'d</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">able</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">stub</span> <span style="background-color:yellow;">ALL</span> <span style="background-color:yellow;">system</span> <span style="background-color:yellow;">time</span> <span style="background-color:yellow;">objects</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">far</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">python</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">concerned.</span> <span style="background-color:yellow;">This</span> <span style="background-color:yellow;">includes</span> <span style="background-color:yellow;">datetime.date.today</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">datetime.datetime.now</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">any</span> <span style="background-color:yellow;">other</span> <span style="background-color:yellow;">standard</span> <span style="background-color:yellow;">date/time</span> <span style="background-color:yellow;">objects</span> . </p>
<p><span style="background-color:yellow;">What</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">standard</span> <span style="background-color:yellow;">way</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">this</span> ? </p>
<br /><h3><span style="background-color:yellow;">Answers</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">Total-7</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">:</span> </h3><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">0</span> </b><br /><p><span style="background-color:yellow;">Replacing</span> <span style="background-color:yellow;">internal</span> <span style="background-color:yellow;">stuff</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">always</span> <span style="background-color:yellow;">dangerous</span> <span style="background-color:yellow;">because</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">nasty</span> <span style="background-color:yellow;">side</span> <span style="background-color:yellow;">effects.</span> <span style="background-color:yellow;">So</span> <span style="background-color:yellow;">what</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">indeed</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">monkey</span> <span style="background-color:yellow;">patching</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">local</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">possible</span> . </p>
<p><span style="background-color:yellow;">We</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">Michael</span> <span style="background-color:yellow;">Foord</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">excellent</span> <span style="background-color:yellow;">mock</span> <span style="background-color:yellow;">library</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">http</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">//www.voidspace.org.uk/python/mock/</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">has</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">@</span> <span style="background-color:yellow;">patch</span> <span style="background-color:yellow;">decorator</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">patches</span> <span style="background-color:yellow;">certain</span> <span style="background-color:yellow;">functionality</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">monkey</span> <span style="background-color:yellow;">patch</span> <span style="background-color:yellow;">only</span> <span style="background-color:yellow;">lives</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">scope</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">testing</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">everything</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">automatically</span> <span style="background-color:yellow;">restored</span> <span style="background-color:yellow;">after</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">runs</span> <span style="background-color:yellow;">out</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">its</span> <span style="background-color:yellow;">scope</span> . </p>
<p><span style="background-color:yellow;">The</span> <span style="background-color:yellow;">only</span> <span style="background-color:yellow;">problem</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">internal</span> <span style="background-color:yellow;">datetime</span> <span style="background-color:yellow;">module</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">implemented</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">default</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">wo</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">able</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">monkey</span> <span style="background-color:yellow;">patch</span> <span style="background-color:yellow;">it.</span> <span style="background-color:yellow;">We</span> <span style="background-color:yellow;">fixed</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">making</span> <span style="background-color:yellow;">our</span> <span style="background-color:yellow;">own</span> <span style="background-color:yellow;">simple</span> <span style="background-color:yellow;">implementation</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">mocked</span> . </p>
<p><span style="background-color:yellow;">The</span> <span style="background-color:yellow;">total</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">something</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">example</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">validator</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">used</span> <span style="background-color:yellow;">within</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">Django</span> <span style="background-color:yellow;">project</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">validate</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">date</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">future</span> <span style="background-color:yellow;"></span> . <span style="background-color:yellow;">Mind</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">took</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">from</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">project</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">took</span> <span style="background-color:yellow;">out</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">non-important</span> <span style="background-color:yellow;">stuff</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">things</span> <span style="background-color:yellow;">may</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">actually</span> <span style="background-color:yellow;">work</span> <span style="background-color:yellow;">when</span> <span style="background-color:yellow;">copy-pasting</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">get</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">idea</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">hope</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;"></span> </p>
<p><span style="background-color:yellow;">First</span> <span style="background-color:yellow;">we</span> <span style="background-color:yellow;">define</span> <span style="background-color:yellow;">our</span> <span style="background-color:yellow;">own</span> <span style="background-color:yellow;">very</span> <span style="background-color:yellow;">simple</span> <span style="background-color:yellow;">implementation</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">datetime.date.today</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">file</span> <span style="background-color:yellow;">called</span> <span style="background-color:yellow;">utils/date.py</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>import datetime

def today():
    return datetime.date.today()
</code></pre>
<p><span style="background-color:yellow;">Then</span> <span style="background-color:yellow;">we</span> <span style="background-color:yellow;">create</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">unittest</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">validator</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">tests.py</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>import datetime
import mock
from unittest2 import TestCase

from django.core.exceptions import ValidationError

from .. import validators

class ValidationTests(TestCase):
    @mock.patch('utils.date.today')
    def test_validate_future_date(self, today_mock):
        # Pin python's today to returning the same date
        # always so we can actually keep on unit testing in the future :)
        today_mock.return_value = datetime.date(2010, 1, 1)

        # A future date should work
        validators.validate_future_date(datetime.date(2010, 1, 2))

        # The mocked today's date should fail
        with self.assertRaises(ValidationError) as e:
            validators.validate_future_date(datetime.date(2010, 1, 1))
        self.assertEquals([u'Date should be in the future.'], e.exception.messages)

        # Date in the past should also fail
        with self.assertRaises(ValidationError) as e:
            validators.validate_future_date(datetime.date(2009, 12, 31))
        self.assertEquals([u'Date should be in the future.'], e.exception.messages)
</code></pre>
<p><span style="background-color:yellow;">The</span> <span style="background-color:yellow;">final</span> <span style="background-color:yellow;">implementation</span> <span style="background-color:yellow;">looks</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>from django.utils.translation import ugettext_lazy as _
from django.core.exceptions import ValidationError

from utils import date

def validate_future_date(value):
    if value <= date.today():
        raise ValidationError(_('Date should be in the future.'))
</code></pre>
<p><span style="background-color:yellow;">Hope</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">helps</span> </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">1</span> </b><br /><p><span style="background-color:yellow;">You</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">write</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">own</span> <span style="background-color:yellow;">datetime</span> <span style="background-color:yellow;">module</span> <span style="background-color:yellow;">replacement</span> <span style="background-color:yellow;">class</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">implementing</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">methods</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">classes</span> <span style="background-color:yellow;">from</span> <span style="background-color:yellow;">datetime</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">replace.</span> <span style="background-color:yellow;">For</span> <span style="background-color:yellow;">example</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>import datetime as datetime_orig

class DatetimeStub(object):
    """A datetimestub object to replace methods and classes from 
    the datetime module. 

    Usage:
        import sys
        sys.modules['datetime'] = DatetimeStub()
    """
    class datetime(datetime_orig.datetime):

        @classmethod
        def now(cls):
            """Override the datetime.now() method to return a
            datetime one year in the future
            """
            result = datetime_orig.datetime.now()
            return result.replace(year=result.year + 1)

    def __getattr__(self, attr):
        """Get the default implementation for the classes and methods
        from datetime that are not replaced
        """
        return getattr(datetime_orig, attr)
</code></pre>
<p><span style="background-color:yellow;">Let</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">put</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">its</span> <span style="background-color:yellow;">own</span> <span style="background-color:yellow;">module</span> <span style="background-color:yellow;">we</span> <span style="background-color:yellow;">'ll</span> <span style="background-color:yellow;">call</span> <span style="background-color:yellow;">datetimestub.py</span> </p>
<p><span style="background-color:yellow;">Then</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">start</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">test</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>import sys
import datetimestub

sys.modules['datetime'] = datetimestub.DatetimeStub()
</code></pre>
<p><span style="background-color:yellow;">Any</span> <span style="background-color:yellow;">subsequent</span> <span style="background-color:yellow;">import</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">datetime</span> <span style="background-color:yellow;">module</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">then</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">datetimestub.DatetimeStub</span> <span style="background-color:yellow;">instance</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">because</span> <span style="background-color:yellow;">when</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">module</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">name</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">used</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">key</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">sys.modules</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">module</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">imported</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">object</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">sys.modules</span> <span style="background-color:yellow;">[</span> <span style="background-color:yellow;">module_name</span> <span style="background-color:yellow;">]</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">used</span> <span style="background-color:yellow;">instead</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">2</span> </b><br /><p><span style="background-color:yellow;">Slight</span> <span style="background-color:yellow;">variation</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">Steef</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">solution.</span> <span style="background-color:yellow;">Rather</span> <span style="background-color:yellow;">than</span> <span style="background-color:yellow;">replacing</span> <span style="background-color:yellow;">datetime</span> <span style="background-color:yellow;">globally</span> <span style="background-color:yellow;">instead</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">just</span> <span style="background-color:yellow;">replace</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">datetime</span> <span style="background-color:yellow;">module</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">just</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">module</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">testing</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">e.g.</span> <span style="background-color:yellow;">:</span> </p>
<pre>
<code>
import models # your module with the Event model
import datetimestub

models.datetime = datetimestub.DatetimeStub()
</code>
</pre>
<p><span style="background-color:yellow;">That</span> <span style="background-color:yellow;">way</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">change</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">much</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">localised</span> <span style="background-color:yellow;">during</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">test</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">3</span> </b><br /><p><span style="background-color:yellow;">What</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">mocked</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">self.end_date</span> <span style="background-color:yellow;">instead</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">datetime</span> ? <span style="background-color:yellow;">Then</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">still</span> <span style="background-color:yellow;">test</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">doing</span> <span style="background-color:yellow;">what</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">without</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">other</span> <span style="background-color:yellow;">crazy</span> <span style="background-color:yellow;">workarounds</span> <span style="background-color:yellow;">suggested</span> . </p>
<p><span style="background-color:yellow;">This</span> <span style="background-color:yellow;">would</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">let</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">stub</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">date/times</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">question</span> <span style="background-color:yellow;">initially</span> <span style="background-color:yellow;">asks</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">might</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">completely</span> <span style="background-color:yellow;">necessary</span> . </p>
<pre>
today = datetime.date.today()

event1 = Event()
event1.end_date = today - datetime.timedelta(days=1) # 1 day ago
event2 = Event()
event2.end_date = today + datetime.timedelta(days=1) # 1 day in future

self.assertTrue(event1.is_over())
self.assertFalse(event2.is_over())
</pre>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">4</span> </b><br /><p><span style="background-color:yellow;">This</span> <span style="background-color:yellow;">does</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">perform</span> <span style="background-color:yellow;">system-wide</span> <span style="background-color:yellow;">datetime</span> <span style="background-color:yellow;">replacement</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">get</span> <span style="background-color:yellow;">fed</span> <span style="background-color:yellow;">up</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">trying</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">get</span> <span style="background-color:yellow;">something</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">work</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">always</span> <span style="background-color:yellow;">add</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">optional</span> <span style="background-color:yellow;">parameter</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">make</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">easier</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">testing</span> . </p>
<pre><code>def is_over(self, today=datetime.datetime.now()):
    return today > self.date_end
</code></pre>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">5</span> </b><br /><p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'d</span> <span style="background-color:yellow;">suggest</span> <span style="background-color:yellow;">taking</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">look</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">testfixtures</span> <span style="background-color:yellow;">test_datetime</span> <span style="background-color:yellow;">:</span> </p>
<p><span style="background-color:yellow;">http</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">//packages.python.org/testfixtures/datetime.html</span> </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">6</span> </b><br /><p><span style="background-color:yellow;">Two</span> <span style="background-color:yellow;">choices</span> . </p>
<ol><span style="background-color:yellow;">Mock</span> <span style="background-color:yellow;">out</span> <span style="background-color:yellow;">datetime</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">providing</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">own.</span> <span style="background-color:yellow;">Since</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">local</span> <span style="background-color:yellow;">directory</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">searched</span> <span style="background-color:yellow;">before</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">standard</span> <span style="background-color:yellow;">library</span> <span style="background-color:yellow;">directories</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">put</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">tests</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">directory</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">own</span> <span style="background-color:yellow;">mock</span> <span style="background-color:yellow;">version</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">datetime.</span> <span style="background-color:yellow;">This</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">harder</span> <span style="background-color:yellow;">than</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">appears</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">because</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">know</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">places</span> <span style="background-color:yellow;">datetime</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">secretly</span> <span style="background-color:yellow;">used</span> . <span style="background-color:yellow;">Use</span> <span style="background-color:yellow;">Strategy</span> . <span style="background-color:yellow;">Replace</span> <span style="background-color:yellow;">explicit</span> <span style="background-color:yellow;">references</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">datetime.date.today</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">datetime.date.now</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">Factory</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">generates</span> <span style="background-color:yellow;">these.</span> <span style="background-color:yellow;">The</span> <span style="background-color:yellow;">Factory</span> <span style="background-color:yellow;">must</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">configured</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">module</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">application</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">unittest</span> <span style="background-color:yellow;"></span> . <span style="background-color:yellow;">This</span> <span style="background-color:yellow;">configuration</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">called</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">Dependency</span> <span style="background-color:yellow;">Injection</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">some</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">allows</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">replace</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">normal</span> <span style="background-color:yellow;">run-time</span> <span style="background-color:yellow;">Factory</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">special</span> <span style="background-color:yellow;">test</span> <span style="background-color:yellow;">factory.</span> <span style="background-color:yellow;">You</span> <span style="background-color:yellow;">gain</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">lot</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">flexibility</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">no</span> <span style="background-color:yellow;">special</span> <span style="background-color:yellow;">case</span> <span style="background-color:yellow;">handling</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">production.</span> <span style="background-color:yellow;">No</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">testing</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">differently</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">business</span> . </ol>
<p><span style="background-color:yellow;">Here</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">Strategy</span> <span style="background-color:yellow;">version</span> . </p>
<pre><code>class DateTimeFactory( object ):
    """Today and now, based on server's defined locale.

    A subclass may apply different rules for determining "today".  
    For example, the broswer's time-zone could be used instead of the
    server's timezone.
    """
    def getToday( self ):
        return datetime.date.today()
    def getNow( self ):
        return datetime.datetime.now()

class Event( models.Model ):
    dateFactory= DateTimeFactory() # Definitions of "now" and "today".
    ... etc. ...

    def is_over( self ):
        return dateFactory.getToday() > self.date_end 


class DateTimeMock( object ):
    def __init__( self, year, month, day, hour=0, minute=0, second=0, date=None ):
        if date:
            self.today= date
            self.now= datetime.datetime.combine(date,datetime.time(hour,minute,second))
        else:
            self.today= datetime.date(year, month, day )
            self.now= datetime.datetime( year, month, day, hour, minute, second )
    def getToday( self ):
        return self.today
    def getNow( self ):
        return self.now
</code></pre>
<p><span style="background-color:yellow;">Now</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">this</span> </p>
<pre><code>class SomeTest( unittest.TestCase ):
    def setUp( self ):
        tomorrow = datetime.date.today() + datetime.timedelta(1)
        self.dateFactoryTomorrow= DateTimeMock( date=tomorrow )
        yesterday = datetime.date.today() + datetime.timedelta(1)
        self.dateFactoryYesterday=  DateTimeMock( date=yesterday )
    def testThis( self ):
        x= Event( ... )
        x.dateFactory= self.dateFactoryTomorrow
        self.assertFalse( x.is_over() )
        x.dateFactory= self.dateFactoryYesterday
        self.asserTrue( x.is_over() )
</code></pre>
<p><span style="background-color:yellow;">In</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">long</span> <span style="background-color:yellow;">run</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">more-or-less</span> <span style="background-color:yellow;">must</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">account</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">browser</span> <span style="background-color:yellow;">locale</span> <span style="background-color:yellow;">separate</span> <span style="background-color:yellow;">from</span> <span style="background-color:yellow;">server</span> <span style="background-color:yellow;">locale.</span> <span style="background-color:yellow;">Using</span> <span style="background-color:yellow;">default</span> <span style="background-color:yellow;">datetime.datetime.now</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">uses</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">server</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">locale</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">may</span> <span style="background-color:yellow;">piss</span> <span style="background-color:yellow;">off</span> <span style="background-color:yellow;">users</span> <span style="background-color:yellow;">who</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">different</span> <span style="background-color:yellow;">time</span> <span style="background-color:yellow;">zone</span> . </p>
<br />