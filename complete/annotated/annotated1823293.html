<h3><span style="background-color:yellow;">Question</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">ID-1823293</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">:</span> </h3><h2><span style="background-color:yellow;">Optimized</span> <span style="background-color:yellow;">method</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">calculating</span> <span style="background-color:yellow;">cosine</span> <span style="background-color:yellow;">distance</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">Python</span> </h2><p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">wrote</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">method</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">calculate</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">cosine</span> <span style="background-color:yellow;">distance</span> <span style="background-color:yellow;">between</span> <span style="background-color:yellow;">two</span> <span style="background-color:yellow;">arrays</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>def cosine_distance(a, b):
    if len(a) != len(b):
    	return False
    numerator = 0
    denoma = 0
    denomb = 0
    for i in range(len(a)):
    	numerator += a[i]*b[i]
    	denoma += abs(a[i])**2
    	denomb += abs(b[i])**2
    result = 1 - numerator / (sqrt(denoma)*sqrt(denomb))
    return result
</code></pre>
<p><span style="background-color:yellow;">Running</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">very</span> <span style="background-color:yellow;">slow</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">large</span> <span style="background-color:yellow;">array.</span> <span style="background-color:yellow;">Is</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">optimized</span> <span style="background-color:yellow;">version</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">method</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">would</span> <span style="background-color:yellow;">run</span> <span style="background-color:yellow;">faster</span> ? </p>
<p><span style="background-color:yellow;">Update</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'ve</span> <span style="background-color:yellow;">tried</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">suggestions</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">date</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">including</span> <span style="background-color:yellow;">scipy.</span> <span style="background-color:yellow;">Here</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">version</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">beat</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">incorporating</span> <span style="background-color:yellow;">suggestions</span> <span style="background-color:yellow;">from</span> <span style="background-color:yellow;">Mike</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">Steve</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>def cosine_distance(a, b):
    if len(a) != len(b):
    	raise ValueError, "a and b must be same length" #Steve
    numerator = 0
    denoma = 0
    denomb = 0
    for i in range(len(a)):       #Mike's optimizations:
    	ai = a[i]             #only calculate once
    	bi = b[i]
    	numerator += ai*bi    #faster than exponent (barely)
    	denoma += ai*ai       #strip abs() since it's squaring
    	denomb += bi*bi
    result = 1 - numerator / (sqrt(denoma)*sqrt(denomb))
    return result
</code></pre>
<br /><h3><span style="background-color:yellow;">Answers</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">Total-8</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">:</span> </h3><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">0</span> </b><br /><p><span style="background-color:yellow;"></span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">originally</span> <span style="background-color:yellow;">thought</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">'re</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">going</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">speed</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">up</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">lot</span> <span style="background-color:yellow;">without</span> <span style="background-color:yellow;">breaking</span> <span style="background-color:yellow;">out</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">numpy</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">scipy</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">changing</span> <span style="background-color:yellow;">what</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">compute.</span> <span style="background-color:yellow;">But</span> <span style="background-color:yellow;">here</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">how</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'d</span> <span style="background-color:yellow;">try</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">anyway</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>from itertools import imap
from math import sqrt
from operator import mul

def cosine_distance(a, b):
    assert len(a) == len(b)
    return 1 - (sum(imap(mul, a, b))
                / sqrt(sum(imap(mul, a, a))
                       * sum(imap(mul, b, b))))
</code></pre>
<p><span style="background-color:yellow;">It</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">roughly</span> <span style="background-color:yellow;">twice</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">fast</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">2.6</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">500k-element</span> <span style="background-color:yellow;">arrays.</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">After</span> <span style="background-color:yellow;">changing</span> <span style="background-color:yellow;">map</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">imap</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">following</span> <span style="background-color:yellow;">Jarret</span> <span style="background-color:yellow;">Hardie.</span> <span style="background-color:yellow;"></span> </p>
<p><span style="background-color:yellow;">Here</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">tweaked</span> <span style="background-color:yellow;">version</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">original</span> <span style="background-color:yellow;">poster</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">revised</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>from itertools import izip

def cosine_distance(a, b):
    assert len(a) == len(b)
    ab_sum, a_sum, b_sum = 0, 0, 0
    for ai, bi in izip(a, b):
        ab_sum += ai * bi
        a_sum += ai * ai
        b_sum += bi * bi
    return 1 - ab_sum / sqrt(a_sum * b_sum)
</code></pre>
<p><span style="background-color:yellow;">It</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">ugly</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">does</span> <span style="background-color:yellow;">come</span> <span style="background-color:yellow;">out</span> <span style="background-color:yellow;">faster.</span> . . </p>
<p><span style="background-color:yellow;">Edit</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">And</span> <span style="background-color:yellow;">try</span> <span style="background-color:yellow;">Psyco</span> <span style="background-color:yellow;">!</span> <span style="background-color:yellow;">It</span> <span style="background-color:yellow;">speeds</span> <span style="background-color:yellow;">up</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">final</span> <span style="background-color:yellow;">version</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">another</span> <span style="background-color:yellow;">factor</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">4.</span> <span style="background-color:yellow;">How</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">forget</span> ? </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">1</span> </b><br /><p><span style="background-color:yellow;">If</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">SciPy</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">cosine</span> <span style="background-color:yellow;">from</span> <span style="background-color:yellow;">spatial.distance</span> <span style="background-color:yellow;">:</span> </p>
<p><span style="background-color:yellow;">http</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">//docs.scipy.org/doc/scipy/reference/spatial.distance.html</span> </p>
<p><span style="background-color:yellow;">If</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">ca</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">SciPy</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">try</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">obtain</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">small</span> <span style="background-color:yellow;">speedup</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">rewriting</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">EDIT</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">did</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">work</span> <span style="background-color:yellow;">out</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">thought</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">would</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">see</span> <span style="background-color:yellow;">below</span> <span style="background-color:yellow;"></span> . </p>
<pre><code>from itertools import izip
from math import sqrt

def cosine_distance(a, b):
    if len(a) != len(b):
        raise ValueError, "a and b must be same length"
    numerator = sum(tup[0] * tup[1] for tup in izip(a,b))
    denoma = sum(avalue ** 2 for avalue in a)
    denomb = sum(bvalue ** 2 for bvalue in b)
    result = 1 - numerator / (sqrt(denoma)*sqrt(denomb))
    return result
</code></pre>
<p><span style="background-color:yellow;">It</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">better</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">raise</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">exception</span> <span style="background-color:yellow;">when</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">lengths</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">b</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">mismatched</span> . </p>
<p><span style="background-color:yellow;">By</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">generator</span> <span style="background-color:yellow;">expressions</span> <span style="background-color:yellow;">inside</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">calls</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">sum</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">calculate</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">values</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">most</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">work</span> <span style="background-color:yellow;">being</span> <span style="background-color:yellow;">done</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">inside</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">Python.</span> <span style="background-color:yellow;">This</span> <span style="background-color:yellow;">should</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">faster</span> <span style="background-color:yellow;">than</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">loop</span> . </p>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">timed</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">ca</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">guess</span> <span style="background-color:yellow;">how</span> <span style="background-color:yellow;">much</span> <span style="background-color:yellow;">faster</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">might</span> <span style="background-color:yellow;">be.</span> <span style="background-color:yellow;">But</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">SciPy</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">almost</span> <span style="background-color:yellow;">certainly</span> <span style="background-color:yellow;">written</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">+</span> <span style="background-color:yellow;">+</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">should</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">about</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">fast</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">get</span> . </p>
<p><span style="background-color:yellow;">If</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">doing</span> <span style="background-color:yellow;">bioinformatics</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">really</span> <span style="background-color:yellow;">should</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">SciPy</span> <span style="background-color:yellow;">anyway</span> . </p>
<p><span style="background-color:yellow;">EDIT</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">Darius</span> <span style="background-color:yellow;">Bacon</span> <span style="background-color:yellow;">timed</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">found</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">slower.</span> <span style="background-color:yellow;">So</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">timed</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">and...</span> <span style="background-color:yellow;">yes</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">slower.</span> <span style="background-color:yellow;">The</span> <span style="background-color:yellow;">lesson</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">when</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">trying</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">speed</span> <span style="background-color:yellow;">things</span> <span style="background-color:yellow;">up</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">guess</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">measure</span> . </p>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">am</span> <span style="background-color:yellow;">baffled</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">why</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">attempt</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">put</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">work</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">internals</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">slower.</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">tried</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">lists</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">length</span> <span style="background-color:yellow;">1000</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">was</span> <span style="background-color:yellow;">still</span> <span style="background-color:yellow;">slower</span> . </p>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">ca</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">spend</span> <span style="background-color:yellow;">any</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">time</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">trying</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">hack</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">cleverly.</span> <span style="background-color:yellow;">If</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">need</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">speed</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">suggest</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">try</span> <span style="background-color:yellow;">SciPy</span> . </p>
<p><span style="background-color:yellow;">EDIT</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">just</span> <span style="background-color:yellow;">tested</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">hand</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">without</span> <span style="background-color:yellow;">timeit.</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">find</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">short</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">b</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">old</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">faster</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">long</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">b</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">new</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">faster</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">both</span> <span style="background-color:yellow;">cases</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">difference</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">large.</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'m</span> <span style="background-color:yellow;">now</span> <span style="background-color:yellow;">wondering</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">trust</span> <span style="background-color:yellow;">timeit</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">Windows</span> <span style="background-color:yellow;">computer</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">try</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">test</span> <span style="background-color:yellow;">again</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">Linux.</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">would</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">change</span> <span style="background-color:yellow;">working</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">try</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">get</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">faster.</span> <span style="background-color:yellow;">And</span> <span style="background-color:yellow;">one</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">time</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">urge</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">try</span> <span style="background-color:yellow;">SciPy.</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">-</span> <span style="background-color:yellow;"></span> </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">2</span> </b><br /><p><span style="background-color:yellow;">No</span> <span style="background-color:yellow;">need</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">take</span> <span style="background-color:yellow;">abs</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">[</span> <span style="background-color:yellow;">i</span> <span style="background-color:yellow;">]</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">b</span> <span style="background-color:yellow;">[</span> <span style="background-color:yellow;">i</span> <span style="background-color:yellow;">]</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">'re</span> <span style="background-color:yellow;">squaring</span> <span style="background-color:yellow;">it</span> . </p>
<p><span style="background-color:yellow;">Store</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">[</span> <span style="background-color:yellow;">i</span> <span style="background-color:yellow;">]</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">b</span> <span style="background-color:yellow;">[</span> <span style="background-color:yellow;">i</span> <span style="background-color:yellow;">]</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">temporary</span> <span style="background-color:yellow;">variables</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">avoid</span> <span style="background-color:yellow;">doing</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">indexing</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">than</span> <span style="background-color:yellow;">once</span> . <span style="background-color:yellow;">Maybe</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">compiler</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">optimize</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">maybe</span> <span style="background-color:yellow;">not</span> . </p>
<p><span style="background-color:yellow;">Check</span> <span style="background-color:yellow;">into</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">*</span> <span style="background-color:yellow;">*</span> <span style="background-color:yellow;">2</span> <span style="background-color:yellow;">operator.</span> <span style="background-color:yellow;">Is</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">simplifying</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">into</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">multiply</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">general</span> <span style="background-color:yellow;">power</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">log</span> <span style="background-color:yellow;">-</span> <span style="background-color:yellow;">multiply</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">2</span> <span style="background-color:yellow;">-</span> <span style="background-color:yellow;">antilog</span> <span style="background-color:yellow;"></span> . </p>
<p><span style="background-color:yellow;">Do</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">sqrt</span> <span style="background-color:yellow;">twice</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">though</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">cost</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">small</span> <span style="background-color:yellow;"></span> . <span style="background-color:yellow;">Do</span> <span style="background-color:yellow;">sqrt</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">denoma</span> <span style="background-color:yellow;">*</span> <span style="background-color:yellow;">denomb</span> <span style="background-color:yellow;"></span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">3</span> </b><br /><p><span style="background-color:yellow;">This</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">faster</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">arrays</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">around</span> <span style="background-color:yellow;">1000</span> <span style="background-color:yellow;">+</span> <span style="background-color:yellow;">elements</span> . </p>
<pre><code>from numpy import array
def cosine_distance(a, b):
    a=array(a)
    b=array(b)
    numerator=(a*b).sum()
    denoma=(a*a).sum()
    denomb=(b*b).sum()
    result = 1 - numerator / sqrt(denoma*denomb)
    return result
</code></pre>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">4</span> </b><br /><p><span style="background-color:yellow;">Similar</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">Darius</span> <span style="background-color:yellow;">Bacon</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">answer</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'ve</span> <span style="background-color:yellow;">been</span> <span style="background-color:yellow;">toying</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">operator</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">itertools</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">produce</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">faster</span> <span style="background-color:yellow;">answer.</span> <span style="background-color:yellow;">The</span> <span style="background-color:yellow;">following</span> <span style="background-color:yellow;">seems</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">1/3</span> <span style="background-color:yellow;">faster</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">500-item</span> <span style="background-color:yellow;">array</span> <span style="background-color:yellow;">according</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">timeit</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>from math import sqrt
from itertools import imap
from operator import mul

def op_cosine(a, b):
    dot_prod = sum(imap(mul, a, b))
    a_veclen = sqrt(sum(i ** 2 for i in a))
    b_veclen = sqrt(sum(i ** 2 for i in b))

    return 1 - dot_prod / (a_veclen * b_veclen)
</code></pre>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">5</span> </b><br /><p><span style="background-color:yellow;">Using</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">inside</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">SciPy</span> <span style="background-color:yellow;">wins</span> <span style="background-color:yellow;">big</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">long</span> <span style="background-color:yellow;">input</span> <span style="background-color:yellow;">arrays.</span> <span style="background-color:yellow;">Using</span> <span style="background-color:yellow;">simple</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">direct</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">wins</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">short</span> <span style="background-color:yellow;">input</span> <span style="background-color:yellow;">arrays</span> <span style="background-color:yellow;">;</span> <span style="background-color:yellow;">Darius</span> <span style="background-color:yellow;">Bacon</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">izip</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">-based</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">benchmarked</span> <span style="background-color:yellow;">out</span> <span style="background-color:yellow;">best.</span> <span style="background-color:yellow;">Thus</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">ultimate</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">decide</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">one</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">runtime</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">based</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">length</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">input</span> <span style="background-color:yellow;">arrays</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>from scipy.spatial.distance import cosine as scipy_cos_dist

from itertools import izip
from math import sqrt

def cosine_distance(a, b):
    len_a = len(a)
    assert len_a == len(b)
    if len_a > 200:  # 200 is a magic value found by benchmark
        return scipy_cos_dist(a, b)
    # function below is basically just Darius Bacon's code
    ab_sum = a_sum = b_sum = 0
    for ai, bi in izip(a, b):
        ab_sum += ai * bi
        a_sum += ai * ai
        b_sum += bi * bi
    return 1 - ab_sum / sqrt(a_sum * b_sum)
</code></pre>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">made</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">test</span> <span style="background-color:yellow;">harness</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">tested</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">functions</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">different</span> <span style="background-color:yellow;">length</span> <span style="background-color:yellow;">inputs</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">found</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">around</span> <span style="background-color:yellow;">length</span> <span style="background-color:yellow;">200</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">SciPy</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">started</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">win.</span> <span style="background-color:yellow;">The</span> <span style="background-color:yellow;">bigger</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">input</span> <span style="background-color:yellow;">arrays</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">bigger</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">wins.</span> <span style="background-color:yellow;">For</span> <span style="background-color:yellow;">very</span> <span style="background-color:yellow;">short</span> <span style="background-color:yellow;">length</span> <span style="background-color:yellow;">arrays</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">say</span> <span style="background-color:yellow;">length</span> <span style="background-color:yellow;">3</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">simpler</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">wins.</span> <span style="background-color:yellow;">This</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">adds</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">tiny</span> <span style="background-color:yellow;">amount</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">overhead</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">decide</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">way</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">then</span> <span style="background-color:yellow;">does</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">best</span> <span style="background-color:yellow;">way</span> . </p>
<p><span style="background-color:yellow;">In</span> <span style="background-color:yellow;">case</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">interested</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">here</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">test</span> <span style="background-color:yellow;">harness</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>from darius2 import cosine_distance as fn_darius2
fn_darius2.__name__ = "fn_darius2"

from ult import cosine_distance as fn_ult
fn_ult.__name__ = "fn_ult"

from scipy.spatial.distance import cosine as fn_scipy
fn_scipy.__name__ = "fn_scipy"

import random
import time

lst_fn = [fn_darius2, fn_scipy, fn_ult]

def run_test(fn, lst0, lst1, test_len):
    start = time.time()
    for _ in xrange(test_len):
        fn(lst0, lst1)
    end = time.time()
    return end - start

for data_len in range(50, 500, 10):
    a = [random.random() for _ in xrange(data_len)]
    b = [random.random() for _ in xrange(data_len)]
    print "len(a) ==", len(a)
    test_len = 10**3
    for fn in lst_fn:
        n = fn.__name__
        r = fn(a, b)
        t = run_test(fn, a, b, test_len)
        print "%s:\t%f seconds, result %f" % (n, t, r)
</code></pre>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">6</span> </b><br /><pre><code>def cd(a,b):
    if(len(a)!=len(b)):
        raise ValueError, "a and b must be the same length"
    rn = range(len(a))
    adb = sum([a[k]*b[k] for k in rn])
    nma = sqrt(sum([a[k]*a[k] for k in rn]))
    nmb = sqrt(sum([b[k]*b[k] for k in rn]))

    result = 1 - adb / (nma*nmb)
    return result
</code></pre>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">7</span> </b><br /><p><span style="background-color:yellow;">Your</span> <span style="background-color:yellow;">updated</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;">still</span> <span style="background-color:yellow;">has</span> <span style="background-color:yellow;">two</span> <span style="background-color:yellow;">square</span> <span style="background-color:yellow;">roots.</span> <span style="background-color:yellow;">You</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">reduce</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">one</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">replacing</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">sqrt</span> <span style="background-color:yellow;">line</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">:</span> </p>
<blockquote><span style="background-color:yellow;">result</span> <span style="background-color:yellow;">=</span> <span style="background-color:yellow;">1</span> <span style="background-color:yellow;">-</span> <span style="background-color:yellow;">numerator</span> <span style="background-color:yellow;">/</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">sqrt</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">denoma</span> <span style="background-color:yellow;">*</span> <span style="background-color:yellow;">denomb</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> </blockquote>
<p><span style="background-color:yellow;">A</span> <span style="background-color:yellow;">multiply</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">typically</span> <span style="background-color:yellow;">quite</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">bit</span> <span style="background-color:yellow;">quicker</span> <span style="background-color:yellow;">than</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">sqrt.</span> <span style="background-color:yellow;">It</span> <span style="background-color:yellow;">might</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">seem</span> <span style="background-color:yellow;">much</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">only</span> <span style="background-color:yellow;">called</span> <span style="background-color:yellow;">once</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">function</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">sounds</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">calculating</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">lot</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">cosine</span> <span style="background-color:yellow;">distances</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">improvement</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">add</span> <span style="background-color:yellow;">up</span> . </p>
<p><span style="background-color:yellow;">Your</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">looks</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">should</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">ripe</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">vector</span> <span style="background-color:yellow;">optimizations.</span> <span style="background-color:yellow;">So</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">cross-platofrm</span> <span style="background-color:yellow;">support</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">issue</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">speed</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">even</span> <span style="background-color:yellow;">further</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">cosine</span> <span style="background-color:yellow;">distance</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">make</span> <span style="background-color:yellow;">sure</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">compiler</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">aggressively</span> <span style="background-color:yellow;">vectorizing</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">resulting</span> <span style="background-color:yellow;">code</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">even</span> <span style="background-color:yellow;">Pentium</span> <span style="background-color:yellow;">II</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">capable</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">some</span> <span style="background-color:yellow;">floating</span> <span style="background-color:yellow;">point</span> <span style="background-color:yellow;">vectorisation</span> <span style="background-color:yellow;"></span> </p>
<br />