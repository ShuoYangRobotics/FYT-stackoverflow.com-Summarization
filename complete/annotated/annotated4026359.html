<h3><span style="background-color:yellow;">Question</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">ID-4026359</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">:</span> </h3><h2><span style="background-color:yellow;">Memory-efficient</span> <span style="background-color:yellow;">string-to-string</span> <span style="background-color:yellow;">map</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;"></span> </h2><p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">need</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">memory-efficient</span> <span style="background-color:yellow;">data</span> <span style="background-color:yellow;">structure</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">storing</span> <span style="background-color:yellow;">about</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">million</span> <span style="background-color:yellow;">key--value</span> <span style="background-color:yellow;">pairs</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">where</span> <span style="background-color:yellow;">keys</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">strings</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">about</span> <span style="background-color:yellow;">80</span> <span style="background-color:yellow;">bytes</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">values</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">strings</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">about</span> <span style="background-color:yellow;">200</span> <span style="background-color:yellow;">bytes</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">total</span> <span style="background-color:yellow;">key</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">value</span> <span style="background-color:yellow;">size</span> <span style="background-color:yellow;">being</span> <span style="background-color:yellow;">about</span> <span style="background-color:yellow;">280MB.</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">also</span> <span style="background-color:yellow;">need</span> <span style="background-color:yellow;">efficient</span> <span style="background-color:yellow;">lookup</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">value</span> <span style="background-color:yellow;">by</span> <span style="background-color:yellow;">key</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">preferably</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">hash-map.</span> <span style="background-color:yellow;">The</span> <span style="background-color:yellow;">memory</span> <span style="background-color:yellow;">overhead</span> <span style="background-color:yellow;">should</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">little</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">possible</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">e.g.</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">280MB</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">useful</span> <span style="background-color:yellow;">data</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">data</span> <span style="background-color:yellow;">structure</span> <span style="background-color:yellow;">should</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">than</span> <span style="background-color:yellow;">300MB</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">virtual</span> <span style="background-color:yellow;">memory</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">including</span> <span style="background-color:yellow;">malloc</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">overhead</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">everything</span> <span style="background-color:yellow;">else</span> <span style="background-color:yellow;"></span> . <span style="background-color:yellow;">The</span> <span style="background-color:yellow;">usage</span> <span style="background-color:yellow;">pattern</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">following</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">we</span> <span style="background-color:yellow;">start</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">empty</span> <span style="background-color:yellow;">data</span> <span style="background-color:yellow;">structure</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">we</span> <span style="background-color:yellow;">populate</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">gradually</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">never</span> <span style="background-color:yellow;">changing</span> <span style="background-color:yellow;">keys</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">never</span> <span style="background-color:yellow;">changing</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">length</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">values.</span> <span style="background-color:yellow;">As</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">plus</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">data</span> <span style="background-color:yellow;">structure</span> <span style="background-color:yellow;">may</span> <span style="background-color:yellow;">support</span> <span style="background-color:yellow;">changing</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">length</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">values</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">expense</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">100</span> <span style="background-color:yellow;">%</span> <span style="background-color:yellow;">value</span> <span style="background-color:yellow;">overhead</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">meaning</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">x</span> <span style="background-color:yellow;">value</span> <span style="background-color:yellow;">bytes</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">x</span> <span style="background-color:yellow;">bytes</span> <span style="background-color:yellow;">might</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">wasted</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">temporarily</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">unused</span> <span style="background-color:yellow;">buffer</span> <span style="background-color:yellow;">space</span> <span style="background-color:yellow;"></span> . </p>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">need</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">pure</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">module</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">built-in</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">module</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">implementation</span> <span style="background-color:yellow;">preferably</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">bindings.</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'d</span> <span style="background-color:yellow;">prefer</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">was</span> <span style="background-color:yellow;">possible</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">serialize</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">whole</span> <span style="background-color:yellow;">data</span> <span style="background-color:yellow;">structure</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">disk</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">read</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">back</span> <span style="background-color:yellow;">very</span> <span style="background-color:yellow;">quickly</span> . </p>
<p><span style="background-color:yellow;">Just</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">prove</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">such</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">small</span> <span style="background-color:yellow;">overhead</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">possible</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'ve</span> <span style="background-color:yellow;">created</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">simple</span> <span style="background-color:yellow;">design</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">open</span> <span style="background-color:yellow;">addressing</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">hash</span> <span style="background-color:yellow;">table</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">1.25</span> <span style="background-color:yellow;">million</span> <span style="background-color:yellow;">elements</span> <span style="background-color:yellow;">containing</span> <span style="background-color:yellow;">4-byte</span> <span style="background-color:yellow;">pointers</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">1MB</span> <span style="background-color:yellow;">data</span> <span style="background-color:yellow;">blocks</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">data</span> <span style="background-color:yellow;">blocks</span> <span style="background-color:yellow;">containing</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">key</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">value</span> <span style="background-color:yellow;">lengths</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">base-128</span> <span style="background-color:yellow;">varints</span> . <span style="background-color:yellow;">This</span> <span style="background-color:yellow;">design</span> <span style="background-color:yellow;">has</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">important</span> <span style="background-color:yellow;">limitation</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">does</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">allow</span> <span style="background-color:yellow;">removing</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">changing</span> <span style="background-color:yellow;">pairs</span> <span style="background-color:yellow;">without</span> <span style="background-color:yellow;">wasting</span> <span style="background-color:yellow;">their</span> <span style="background-color:yellow;">memory</span> <span style="background-color:yellow;">area.</span> <span style="background-color:yellow;">According</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">calculations</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">1</span> <span style="background-color:yellow;">million</span> <span style="background-color:yellow;">key--value</span> <span style="background-color:yellow;">pairs</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">280</span> <span style="background-color:yellow;">bytes</span> <span style="background-color:yellow;">each</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">overhead</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">less</span> <span style="background-color:yellow;">than</span> <span style="background-color:yellow;">3.6</span> <span style="background-color:yellow;">%</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">10</span> <span style="background-color:yellow;">080</span> <span style="background-color:yellow;">000</span> <span style="background-color:yellow;">bytes</span> <span style="background-color:yellow;"></span> . <span style="background-color:yellow;">The</span> <span style="background-color:yellow;">limits</span> <span style="background-color:yellow;">above</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">generous</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">they</span> <span style="background-color:yellow;">allow</span> <span style="background-color:yellow;">20</span> <span style="background-color:yellow;">000</span> <span style="background-color:yellow;">000</span> <span style="background-color:yellow;">bytes</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">overhead</span> . </p>
<p><span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'ve</span> <span style="background-color:yellow;">just</span> <span style="background-color:yellow;">found</span> <span style="background-color:yellow;">http</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">//www.pytables.org/</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">provides</span> <span style="background-color:yellow;">fast</span> <span style="background-color:yellow;">access</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">memory-efficient</span> <span style="background-color:yellow;">packing</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">data.</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">examine</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">closely</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">check</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">suits</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">needs</span> . </p>
<br /><h3><span style="background-color:yellow;">Answers</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">Total-9</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">:</span> </h3><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">0</span> </b><br /><p><span style="background-color:yellow;">Martijn</span> <span style="background-color:yellow;">mentioned</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">comment</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">sure</span> <span style="background-color:yellow;">why</span> <span style="background-color:yellow;">people</span> <span style="background-color:yellow;">comment</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">answers</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">agree</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">SQLite.</span> <span style="background-color:yellow;">You</span> <span style="background-color:yellow;">should</span> <span style="background-color:yellow;">give</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">try</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">see</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">meet</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">needs</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">1</span> </b><br /><p><span style="background-color:yellow;">If</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">plan</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">large</span> <span style="background-color:yellow;">amounts</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">deletes</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">then</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">hard.</span> <span style="background-color:yellow;">Deletes</span> <span style="background-color:yellow;">lead</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">fragmentation</span> . </p>
<p><span style="background-color:yellow;">You</span> <span style="background-color:yellow;">also</span> <span style="background-color:yellow;">need</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">commit</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">fixed</span> <span style="background-color:yellow;">length</span> <span style="background-color:yellow;">key.</span> <span style="background-color:yellow;">You</span> <span style="background-color:yellow;">mentioned</span> <span style="background-color:yellow;">80</span> <span style="background-color:yellow;">bytes.</span> <span style="background-color:yellow;">Are</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">keys</span> <span style="background-color:yellow;">allowed</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">duplicate</span> ? <span style="background-color:yellow;">If</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">even</span> <span style="background-color:yellow;">easier</span> . </p>
<p><span style="background-color:yellow;">So</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">here</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">what</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">do</span> . </p>
<p><span style="background-color:yellow;">You</span> <span style="background-color:yellow;">create</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">array</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>struct {
    char value[80];
    char *data;
} key;
</code></pre>
<p><span style="background-color:yellow;">And</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">keep</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">array</span> <span style="background-color:yellow;">sorted</span> . </p>
<p><span style="background-color:yellow;">If</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">keys</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">duplicate</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">then</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">need</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>struct link {
    char *data;
    link *next;
}

struct {
    char value[80];
    link *data;
} key;
</code></pre>
<p><span style="background-color:yellow;"></span> <span style="background-color:yellow;">My</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">rusty</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">gist</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">The</span> <span style="background-color:yellow;">latter</span> <span style="background-color:yellow;">has</span> <span style="background-color:yellow;">each</span> <span style="background-color:yellow;">key</span> <span style="background-color:yellow;">pointing</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">linked</span> <span style="background-color:yellow;">list</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">values</span> . </p>
<p><span style="background-color:yellow;">Then</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">lookup</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">simple</span> <span style="background-color:yellow;">binary</span> <span style="background-color:yellow;">search.</span> <span style="background-color:yellow;">The</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">pain</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">maintaining</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">array</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">inserting/deleting</span> <span style="background-color:yellow;">keys.</span> <span style="background-color:yellow;">It</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">painful</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">sounds</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">saves</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">LOT</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">memory</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">especially</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">64bit</span> <span style="background-color:yellow;">systems</span> . </p>
<p><span style="background-color:yellow;">What</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">reduce</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">number</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">pointers.</span> <span style="background-color:yellow;">Pointers</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">expensive</span> <span style="background-color:yellow;">when</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">lots</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">structures</span> <span style="background-color:yellow;">filled</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">pointers.</span> <span style="background-color:yellow;">On</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">64bit</span> <span style="background-color:yellow;">system</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">pointer</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">8</span> <span style="background-color:yellow;">bytes.</span> <span style="background-color:yellow;">So</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">single</span> <span style="background-color:yellow;">pointer</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">goes</span> <span style="background-color:yellow;">8MB</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">memory</span> <span style="background-color:yellow;">budget</span> . </p>
<p><span style="background-color:yellow;">So</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">expense</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">building</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">array</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">copying</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">compacting</span> <span style="background-color:yellow;">memory</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">know</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">million</span> <span style="background-color:yellow;">rows</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">commit</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">then</span> <span style="background-color:yellow;">malloc</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">1000000</span> <span style="background-color:yellow;">*</span> <span style="background-color:yellow;">sizeof</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">key</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">right</span> <span style="background-color:yellow;">away</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">'ll</span> <span style="background-color:yellow;">save</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">some</span> <span style="background-color:yellow;">copying</span> <span style="background-color:yellow;">during</span> <span style="background-color:yellow;">expansion</span> <span style="background-color:yellow;"></span> . </p>
<p><span style="background-color:yellow;">But</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">afraid</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">once</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">up</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">running</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">performance</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">quite</span> <span style="background-color:yellow;">good.</span> <span style="background-color:yellow;">Modern</span> <span style="background-color:yellow;">cpus</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">actually</span> <span style="background-color:yellow;">pretty</span> <span style="background-color:yellow;">good</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">copying</span> <span style="background-color:yellow;">100M</span> <span style="background-color:yellow;">blocks</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">memory</span> <span style="background-color:yellow;">around</span> . </p>
<p><span style="background-color:yellow;">Just</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">aside</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">just</span> <span style="background-color:yellow;">did</span> <span style="background-color:yellow;">something</span> <span style="background-color:yellow;">much</span> <span style="background-color:yellow;">like</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">Java.</span> <span style="background-color:yellow;">On</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">64bit</span> <span style="background-color:yellow;">JVM</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">Map</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">25M</span> <span style="background-color:yellow;">entries</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">2G</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">RAM.</span> <span style="background-color:yellow;">My</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">similar</span> <span style="background-color:yellow;">techniques</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">has</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">around</span> <span style="background-color:yellow;">600M</span> <span style="background-color:yellow;"></span> . <span style="background-color:yellow;">Java</span> <span style="background-color:yellow;">uses</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">pointers</span> <span style="background-color:yellow;">than</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">premise</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">same</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">2</span> </b><br /><p><span style="background-color:yellow;">Ok</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">dirt-simple</span> <span style="background-color:yellow;">approach</span> . </p>
<p><span style="background-color:yellow;">Use</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">python</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">data</span> <span style="background-color:yellow;">structure.</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">filled</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">python</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">1</span> <span style="background-color:yellow;">million</span> <span style="background-color:yellow;">random</span> <span style="background-color:yellow;">key-value</span> <span style="background-color:yellow;">pairs</span> <span style="background-color:yellow;">where</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">key</span> <span style="background-color:yellow;">was</span> <span style="background-color:yellow;">80</span> <span style="background-color:yellow;">characters</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">value</span> <span style="background-color:yellow;">200</span> <span style="background-color:yellow;">characters.</span> <span style="background-color:yellow;">It</span> <span style="background-color:yellow;">took</span> <span style="background-color:yellow;">360,844</span> <span style="background-color:yellow;">Kb</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">computer</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">outside</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">specification</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">no</span> <span style="background-color:yellow;">more</span> <span style="background-color:yellow;">than</span> <span style="background-color:yellow;">300</span> <span style="background-color:yellow;">MB</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">offer</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">up</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">solution</span> <span style="background-color:yellow;">anyway</span> <span style="background-color:yellow;">because</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">still</span> <span style="background-color:yellow;">pretty</span> <span style="background-color:yellow;">memory</span> <span style="background-color:yellow;">efficient</span> . </p>
<p><span style="background-color:yellow;">This</span> <span style="background-color:yellow;">also</span> <span style="background-color:yellow;">fails</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">requirement</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">having</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">API.</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'m</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">sure</span> <span style="background-color:yellow;">why</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">need</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">question</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">tagged</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">lacks</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">tag</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'ll</span> <span style="background-color:yellow;">offer</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">pure</span> <span style="background-color:yellow;">Python</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">see</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">just</span> <span style="background-color:yellow;">might</span> <span style="background-color:yellow;">fit</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">bill</span> . </p>
<p><span style="background-color:yellow;">Regarding</span> <span style="background-color:yellow;">persistence.</span> <span style="background-color:yellow;">Use</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">cPickle</span> <span style="background-color:yellow;">module.</span> <span style="background-color:yellow;">It</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">very</span> <span style="background-color:yellow;">fast</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">again</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">dirt-simple.</span> <span style="background-color:yellow;">To</span> <span style="background-color:yellow;">save</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>cPickle.dump(mydict, "myfile.pkl")
</code></pre>
<p><span style="background-color:yellow;">To</span> <span style="background-color:yellow;">reload</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>mydict = cPickle.load("myfile.pkl")
</code></pre>
<p><span style="background-color:yellow;">A</span> <span style="background-color:yellow;">second</span> <span style="background-color:yellow;">dirt-simple</span> <span style="background-color:yellow;">idea</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">shelve</span> <span style="background-color:yellow;">module</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">basically</span> <span style="background-color:yellow;">disk-based</span> <span style="background-color:yellow;">python</span> <span style="background-color:yellow;">dictionary.</span> <span style="background-color:yellow;">Memory</span> <span style="background-color:yellow;">overhead</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">very</span> <span style="background-color:yellow;">low</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">disk</span> <span style="background-color:yellow;"></span> . <span style="background-color:yellow;">But</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">also</span> <span style="background-color:yellow;">much</span> <span style="background-color:yellow;">slower</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">3</span> </b><br /><p><span style="background-color:yellow;">Have</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">tried</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">straightforward</span> <span style="background-color:yellow;">dict</span> ? <span style="background-color:yellow;">Most</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">data</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">strings</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">overhead</span> <span style="background-color:yellow;">might</span> <span style="background-color:yellow;">fit</span> <span style="background-color:yellow;">within</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">requirements</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">4</span> </b><br /><p><span style="background-color:yellow;">You</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">sha1</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">key</span> <span style="background-color:yellow;">instead</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">key</span> <span style="background-color:yellow;">itself.</span> <span style="background-color:yellow;">If</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">keys</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">unique</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">then</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">sha1</span> <span style="background-color:yellow;">hash</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">keys</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">likely</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">too.</span> <span style="background-color:yellow;">It</span> <span style="background-color:yellow;">provides</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">memory</span> <span style="background-color:yellow;">savings</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">try</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">squeak</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">under</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">limit</span> . </p>
<pre><code>from random import choice
from string import letters
from hashlib import sha1

def keygen(length):
    return "".join(choice(letters) for _ in xrange(length))

def gentestdata(n=1000*1000):
    # return dict((sha1(keygen(80)).digest(), keygen(200)) for _ in xrange(n))
    d = {}
    for _ in xrange(n):
        key = sha1(keygen(80)).digest()
        assert key not in d
        value = keygen(200)
        d[key] = value
    return d

if __name__ == '__main__':
    d = gentestdata()
</code></pre>
<p><span style="background-color:yellow;">On</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">ubuntu</span> <span style="background-color:yellow;">box</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">tops</span> <span style="background-color:yellow;">out</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">304</span> <span style="background-color:yellow;">MB</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">memory</span> <span style="background-color:yellow;">:</span> </p>
<pre><code>2010-10-26 14:26:02 hbrown@hbrown-ubuntu-wks:~$ ps aux | grep python
[...]
hbrown   12082 78.2  7.5 307420 303128 pts/1   S+   14:20   4:47 python
</code></pre>
<p><span style="background-color:yellow;">Close</span> <span style="background-color:yellow;">enough</span> ? <span style="background-color:yellow;">It</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">python</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">C</span> . </p>
<hr />
<p><span style="background-color:yellow;">Later</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">also</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">data</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">somewhat</span> <span style="background-color:yellow;">redundant</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">gzip</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">values.</span> <span style="background-color:yellow;">It</span> <span style="background-color:yellow;">'s</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">time</span> <span style="background-color:yellow;">versus</span> <span style="background-color:yellow;">space</span> <span style="background-color:yellow;">trade-off</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">5</span> </b><br /><p><span style="background-color:yellow;">Using</span> <span style="background-color:yellow;">SQLite</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">good</span> <span style="background-color:yellow;">idea.</span> <span style="background-color:yellow;">A</span> <span style="background-color:yellow;">quick</span> <span style="background-color:yellow;">implementation</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">tell</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">fast</span> <span style="background-color:yellow;">enough</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">little</span> <span style="background-color:yellow;">effort</span> . </p>
<hr />
<p><span style="background-color:yellow;">If</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">determine</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">roll</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">own</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'d</span> <span style="background-color:yellow;">recommend</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">following</span> <span style="background-color:yellow;">:</span> </p>
<p><span style="background-color:yellow;">How</span> <span style="background-color:yellow;">well</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">predict</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">number</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">pairs</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">upper</span> <span style="background-color:yellow;">limit</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">that</span> ? <span style="background-color:yellow;">How</span> <span style="background-color:yellow;">well</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">predict</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">total</span> <span style="background-color:yellow;">data</span> <span style="background-color:yellow;">size</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">an</span> <span style="background-color:yellow;">upper</span> <span style="background-color:yellow;">limit</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">that</span> ? </p>
<p><span style="background-color:yellow;">Arena</span> <span style="background-color:yellow;">allocator</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">strings</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">nodes.</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">Usually</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">'d</span> <span style="background-color:yellow;">work</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">list</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">arenas</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">so</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">predict</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">total</span> <span style="background-color:yellow;">size</span> <span style="background-color:yellow;"></span> . </p>
<p><span style="background-color:yellow;">Alignment</span> <span style="background-color:yellow;">depends</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">algorithms</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">principle</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">pack</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">byte-tight</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">only</span> <span style="background-color:yellow;">overhead</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">overallocation</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">only</span> <span style="background-color:yellow;">minimally</span> <span style="background-color:yellow;">affects</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">working</span> <span style="background-color:yellow;">set</span> . </p>
<p><span style="background-color:yellow;">However</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">run</span> <span style="background-color:yellow;">any</span> <span style="background-color:yellow;">cmp/copy</span> <span style="background-color:yellow;">etc.</span> <span style="background-color:yellow;">operations</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">these</span> <span style="background-color:yellow;">strings</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">remember</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">following</span> <span style="background-color:yellow;">guarantees</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">squeeze</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">little</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">lot</span> <span style="background-color:yellow;">from</span> <span style="background-color:yellow;">these</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">operations</span> <span style="background-color:yellow;">:</span> </p>
<ul><span style="background-color:yellow;">all</span> <span style="background-color:yellow;">elements</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">CPU</span> <span style="background-color:yellow;">word</span> <span style="background-color:yellow;">aligned</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">pad</span> <span style="background-color:yellow;">bytes</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">e.g.</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">0</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">safely</span> <span style="background-color:yellow;">read</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">beyond</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">end</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">long</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">cross</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">CPU</span> <span style="background-color:yellow;">border</span> </ul>
<hr />
<p><span style="background-color:yellow;">Hash</span> <span style="background-color:yellow;">table</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">index.</span> <span style="background-color:yellow;">A</span> <span style="background-color:yellow;">dictionary</span> <span style="background-color:yellow;">would</span> <span style="background-color:yellow;">work</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">too</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">makes</span> <span style="background-color:yellow;">sense</span> <span style="background-color:yellow;">only</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">potential</span> <span style="background-color:yellow;">degradation</span> <span style="background-color:yellow;">/</span> <span style="background-color:yellow;">rehashing</span> <span style="background-color:yellow;">would</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">serious</span> <span style="background-color:yellow;">issue.</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">do</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">know</span> <span style="background-color:yellow;">any</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">stock</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">hashtable</span> <span style="background-color:yellow;">implementation</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">but</span> <span style="background-color:yellow;">there</span> <span style="background-color:yellow;">should</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">one</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">right</span> ? <span style="background-color:yellow;">right</span> ? <span style="background-color:yellow;">Just</span> <span style="background-color:yellow;">replace</span> <span style="background-color:yellow;">allocations</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">calls</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">arena</span> <span style="background-color:yellow;">allocator</span> . </p>
<hr />
<p><span style="background-color:yellow;">Memory</span> <span style="background-color:yellow;">Locality</span> </p>
<p><span style="background-color:yellow;">If</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">guarantee</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">lookup</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">never</span> <span style="background-color:yellow;">request</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">string</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">not</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">map</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">should</span> <span style="background-color:yellow;">store</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">keys</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">separate</span> <span style="background-color:yellow;">arena</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">as</span> <span style="background-color:yellow;">they</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">needed</span> <span style="background-color:yellow;">only</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">hash</span> <span style="background-color:yellow;">collisions.</span> <span style="background-color:yellow;">That</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">improve</span> <span style="background-color:yellow;">memory</span> <span style="background-color:yellow;">locality</span> <span style="background-color:yellow;">significantly.</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">In</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">case</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">ever</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">final</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">table</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">even</span> <span style="background-color:yellow;">copy</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">colliding</span> <span style="background-color:yellow;">keys</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">new</span> <span style="background-color:yellow;">arena</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">throw</span> <span style="background-color:yellow;">away</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">others.</span> <span style="background-color:yellow;">The</span> <span style="background-color:yellow;">benefits</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">that</span> <span style="background-color:yellow;">are</span> <span style="background-color:yellow;">probably</span> <span style="background-color:yellow;">marginal</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">though.</span> <span style="background-color:yellow;"></span> </p>
<p><span style="background-color:yellow;">Separation</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">help</span> <span style="background-color:yellow;">or</span> <span style="background-color:yellow;">hurt</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">depending</span> <span style="background-color:yellow;">on</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">access</span> <span style="background-color:yellow;">patterns.</span> <span style="background-color:yellow;">If</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">typically</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">value</span> <span style="background-color:yellow;">once</span> <span style="background-color:yellow;">after</span> <span style="background-color:yellow;">each</span> <span style="background-color:yellow;">lookup</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">having</span> <span style="background-color:yellow;">them</span> <span style="background-color:yellow;">pair-wise</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">same</span> <span style="background-color:yellow;">arena</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">great.</span> <span style="background-color:yellow;">If</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">e.g.</span> <span style="background-color:yellow;">look</span> <span style="background-color:yellow;">up</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">few</span> <span style="background-color:yellow;">keys</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">then</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">their</span> <span style="background-color:yellow;">values</span> <span style="background-color:yellow;">repeatedly</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">separate</span> <span style="background-color:yellow;">arenas</span> <span style="background-color:yellow;">make</span> <span style="background-color:yellow;">sense</span> . </p>
<hr />
<p><span style="background-color:yellow;">If</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">have</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">support</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">funny</span> <span style="background-color:yellow;">characters</span> <span style="background-color:yellow;">"</span> <span style="background-color:yellow;">/</span> <span style="background-color:yellow;">Unicode</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">normalize</span> <span style="background-color:yellow;">your</span> <span style="background-color:yellow;">strings</span> <span style="background-color:yellow;">before</span> <span style="background-color:yellow;">storing</span> <span style="background-color:yellow;">them</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">6</span> </b><br /><p><span style="background-color:yellow;">You</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">use</span> <span style="background-color:yellow;">struct</span> <span style="background-color:yellow;">module</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">pack</span> <span style="background-color:yellow;">binary</span> <span style="background-color:yellow;">data</span> <span style="background-color:yellow;">and</span> <span style="background-color:yellow;">unpack</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">when</span> <span style="background-color:yellow;">needed</span> . <span style="background-color:yellow;">You</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">implement</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">memory</span> <span style="background-color:yellow;">efficient</span> <span style="background-color:yellow;">storage</span> <span style="background-color:yellow;">using</span> <span style="background-color:yellow;">this</span> <span style="background-color:yellow;">approach.</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">guess</span> <span style="background-color:yellow;">access</span> <span style="background-color:yellow;">would</span> <span style="background-color:yellow;">be</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">pain</span> . </p>
<ul><span style="background-color:yellow;">http</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">//docs.python.org/library/struct.html</span> </ul>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">7</span> </b><br /><p><span style="background-color:yellow;">Apache</span> <span style="background-color:yellow;">Portable</span> <span style="background-color:yellow;">Runtime</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">aka</span> <span style="background-color:yellow;">APR</span> <span style="background-color:yellow;"></span> <span style="background-color:yellow;">has</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">c-based</span> <span style="background-color:yellow;">hash</span> <span style="background-color:yellow;">table.</span> <span style="background-color:yellow;">You</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">see</span> <span style="background-color:yellow;">documentation</span> <span style="background-color:yellow;">at</span> <span style="background-color:yellow;">http</span> <span style="background-color:yellow;">:</span> <span style="background-color:yellow;">//apr.apache.org/docs/apr/0.9/group_</span> <span style="background-color:yellow;">apr</span> <span style="background-color:yellow;">_hash.html</span> </p>
<p><span style="background-color:yellow;">With</span> <span style="background-color:yellow;">apr_hash_t</span> <span style="background-color:yellow;">all</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">store</span> <span style="background-color:yellow;">is</span> <span style="background-color:yellow;">void</span> <span style="background-color:yellow;">*</span> . <span style="background-color:yellow;">So</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">gives</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">full</span> <span style="background-color:yellow;">control</span> <span style="background-color:yellow;">over</span> <span style="background-color:yellow;">values.</span> <span style="background-color:yellow;">SO</span> <span style="background-color:yellow;">if</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">want</span> <span style="background-color:yellow;">you</span> <span style="background-color:yellow;">can</span> <span style="background-color:yellow;">store</span> <span style="background-color:yellow;">pointer</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">a</span> <span style="background-color:yellow;">100</span> <span style="background-color:yellow;">byte</span> <span style="background-color:yellow;">block</span> <span style="background-color:yellow;">instead</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">actual</span> <span style="background-color:yellow;">length</span> <span style="background-color:yellow;">of</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">string</span> . </p>
<br /><b><span style="background-color:yellow;">#</span> <span style="background-color:yellow;">8</span> </b><br /><p><span style="background-color:yellow;">Since</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">could</span> <span style="background-color:yellow;">n't</span> <span style="background-color:yellow;">find</span> <span style="background-color:yellow;">any</span> <span style="background-color:yellow;">existing</span> <span style="background-color:yellow;">solutions</span> <span style="background-color:yellow;">which</span> <span style="background-color:yellow;">will</span> <span style="background-color:yellow;">pack</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">memory</span> <span style="background-color:yellow;">tightly</span> <span style="background-color:yellow;">,</span> <span style="background-color:yellow;">I</span> <span style="background-color:yellow;">'ve</span> <span style="background-color:yellow;">decided</span> <span style="background-color:yellow;">to</span> <span style="background-color:yellow;">implement</span> <span style="background-color:yellow;">it</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">C</span> <span style="background-color:yellow;">for</span> <span style="background-color:yellow;">myself.</span> <span style="background-color:yellow;">See</span> <span style="background-color:yellow;">my</span> <span style="background-color:yellow;">design</span> <span style="background-color:yellow;">with</span> <span style="background-color:yellow;">open</span> <span style="background-color:yellow;">addressing</span> <span style="background-color:yellow;">in</span> <span style="background-color:yellow;">the</span> <span style="background-color:yellow;">question</span> . </p>
<br />