[[{"text": ["There are lots of answers on what to do in general about restricting Python at http://wiki.python.org/moin/SandboxedPython.", "When I looked at it some time ago, the Zope RestrictedPython looked the best solution, working with a whitelist system.", "You'll still need to take care in your own code so that you don't expose any security vulnerabilities, but that seems to be the best system out there."], "childNum": 1, "tag": "p", "senID": 0, "childList": [{"text": "http://wiki.python.org/moin/SandboxedPython", "tag": "a", "pos": 0, "childList": [], "childNum": 0, "href": "http://wiki.python.org/moin/SandboxedPython"}]}], [{"text": ["You will really need to avoid eval.", "Imagine code such as:"], "childNum": 0, "tag": "p", "senID": 0, "childList": []}, {"code": "<pre>\n<code>\n eval(\"__impor\" + \"t__('whatever').destroy_your_server\")\n</code>\n</pre>\n", "senID": 1}, {"text": ["This is probably the most important one."], "childNum": 0, "tag": "p", "senID": 2, "childList": []}], [{"text": ["Since you sound determined to do this, I'll link you to the standard rexec module, not because I think you should use it (don't - it has known vulnerabilities), but because it might be a good starting point for getting your webserver compromised your own restricted-execution framework."], "childNum": 4, "tag": "p", "senID": 0, "childList": [{"text": "rexec", "tag": "a", "pos": 0, "childList": [], "childNum": 0, "href": "http://docs.python.org/library/rexec.html"}, {"text": "don't", "childNum": 0, "tag": "strong", "childList": []}, {"href": "http://bugs.python.org/issue577530", "text": "known vulnerabilities", "childNum": 0, "tag": "a", "childList": []}, {"text": "getting your webserver compromised", "childNum": 0, "tag": "s", "childList": []}]}, {"text": ["In particular, under the heading \"Defining restricted environments\" several modules and functions are listed that were considered reasonably safe by the rexec designer; these might be usable as an initial whitelist of sorts.", "I'd also suggest examining its code for other gotchas you might not have thought of."], "childNum": 0, "tag": "p", "senID": 1, "childList": []}], [{"text": ["Yeah, you have to whitelist.", "There are so many ways to hide the bad commands."], "childNum": 0, "tag": "p", "senID": 0, "childList": []}, {"text": ["This is NOT the worst case scenario:"], "childNum": 1, "tag": "p", "senID": 1, "childList": [{"text": "NOT", "childNum": 0, "tag": "strong", "pos": 0, "childList": []}]}, {"text": ["The worst case scenario is getting the entire machine rooted and you not noticing as it probes your other machines and keylogs your passwords.", "Isolate this machine and consider it hostile (DMZ, block it from being able to launch attacks internally and externally, etc).", "Run tripwire or AIDE on non-writeable media and log everything to a second host.  "], "childNum": 0, "tag": "p", "senID": 2, "childList": []}, {"text": ["Finally, as plash shows, there are a lot of dangerous system calls that need to be protected against."], "childNum": 1, "tag": "p", "senID": 3, "childList": [{"text": "plash", "tag": "a", "pos": 0, "childList": [], "childNum": 0, "href": "http://plash.beasts.org/environment.html"}]}], [{"text": ["You should use a whitelist, rather than a blacklist.", "If you use a blacklist, you will always miss something.", "Even if you don't, Python will add a function to the standard library, and you won't update your blacklist in time."], "childNum": 0, "tag": "p", "senID": 0, "childList": []}, {"text": ["Things you're currently allowing but probably should not include:"], "childNum": 0, "tag": "p", "senID": 1, "childList": []}, {"tag": "ul", "num": 3, "lis": [{"text": ["compile"], "childNum": 1, "tag": "a", "senID": 2, "childList": [{"text": "compile", "childNum": 0, "tag": "code", "pos": 0, "childList": []}]}, {"text": ["eval"], "childNum": 1, "tag": "a", "senID": 3, "childList": [{"text": "eval", "childNum": 0, "tag": "code", "pos": 0, "childList": []}]}, {"text": ["reload"], "childNum": 1, "tag": "a", "senID": 4, "childList": [{"text": "reload", "childNum": 0, "tag": "code", "pos": 0, "childList": []}]}]}, {"text": ["I agree that this would be very tricky to do correctly.", "One complication (among many) could be a user accessing one of these functions through a field in another class."], "childNum": 0, "tag": "p", "senID": 5, "childList": []}, {"text": ["I would consider using another isolation mechanism, such as a virtual machine, instead or in addition to this.", "You might look at how codepad does it."], "childNum": 1, "tag": "p", "senID": 6, "childList": [{"text": "codepad", "tag": "a", "pos": 1, "childList": [], "childNum": 0, "href": "http://codepad.org/about"}]}], [{"text": ["If you're not committed to using Python as the language inside the game, one possibility would be to embed Lua using LunaticPython (I suggest the bugfixes branch at https://code.launchpad.net/~dne/lunatic-python/bugfixes)."], "childNum": 1, "tag": "p", "senID": 0, "childList": [{"text": "https://code.launchpad.net/~dne/lunatic-python/bugfixes", "tag": "a", "pos": 0, "childList": [], "childNum": 0, "href": "https://code.launchpad.net/~dne/lunatic-python/bugfixes"}]}, {"text": ["It's much easier to sandbox Lua than Python, and it's much easier to embed Lua than to create your own programming language."], "childNum": 0, "tag": "p", "senID": 1, "childList": []}]]