[[{"text": ["This is really non-trivial."], "childNum": 0, "tag": "p", "senID": 0, "childList": []}, {"text": ["There are two ways to sandbox Python.", "One is to create a restricted environment (i.e., very few globals etc.", ") and exec your code inside this environment.", "This is what Messa is suggesting.", "It's nice but there are lots of ways to break out of the sandbox and create trouble.", "There was a thread about this on Python-dev a year ago or so in which people did things from catching exceptions and poking at internal state to break out to byte code manipulation.", "This is the way to go if you want a complete language."], "childNum": 1, "tag": "p", "senID": 1, "childList": [{"text": "exec", "childNum": 0, "tag": "code", "pos": 2, "childList": []}]}, {"text": ["The other way is to parse the code and then use the ast module to kick out constructs you don't want (e.g.", "import statements, function calls etc.", ") and then to compile the rest.", "This is the way to go if you want to use Python as a config language etc."], "childNum": 1, "tag": "p", "senID": 2, "childList": [{"text": "ast", "childNum": 0, "tag": "code", "pos": 0, "childList": []}]}, {"text": ["Another way (which might not work for you since you're using GAE), is the PyPy sandbox.", "While I haven't used it myself, word on the intertubes is that it's the only real sandboxed Python out there. "], "childNum": 2, "tag": "p", "senID": 3, "childList": [{"text": "PyPy sandbox", "tag": "a", "pos": 0, "childList": [], "childNum": 0, "href": "http://codespeak.net/pypy/dist/pypy/doc/sandbox.html"}, {"text": "real", "childNum": 0, "tag": "em", "pos": 1, "childList": []}]}, {"text": ["Based on your description of the requirements (The requirements are support for variables, basic conditionals and function calls (not definitions)) , you might want to evaluate approach 2 and kick out everything else from the code.", "It's a little tricky but doable."], "childNum": 1, "tag": "p", "senID": 4, "childList": [{"text": "might", "childNum": 0, "tag": "em", "pos": 0, "childList": []}]}], [{"text": ["AFAIK it is possible to run a code in a completely isolated environment:"], "childNum": 0, "tag": "p", "senID": 0, "childList": []}, {"code": "<pre>\n<code>\n exec somePythonCode in {'__builtins__': {}}, {}\n</code>\n</pre>\n", "senID": 1}, {"text": ["But in such environment you can do almost nothing :) (you can not even import a module; but still a malicious user can run an infinite recursion or cause running out of memory.", ") Probably you would want to add some modules that will be the interface to you game engine."], "childNum": 1, "tag": "p", "senID": 2, "childList": [{"text": "import", "childNum": 0, "tag": "code", "pos": 0, "childList": []}]}], [{"text": ["I would look into a two server approach.", "The first server is the privileged web server where your code lives.", "The second server is a very tightly controlled server that only provides a web service or RPC service and runs the untrusted code.", "You provide your content creator with  your custom interface.", "For example you if you allowed the end user to create items, you would have a look up that called the server with the code to execute and the set of parameters."], "childNum": 0, "tag": "p", "senID": 0, "childList": []}, {"text": ["Here's and abstract example for a healing potion."], "childNum": 0, "tag": "p", "senID": 1, "childList": []}, {"code": "<pre>\n<code>\n {function_id='healing potion', action='use', target='self', inventory_id='1234'}\n</code>\n</pre>\n", "senID": 2}, {"text": ["The response might be something like "], "childNum": 0, "tag": "p", "senID": 3, "childList": []}, {"code": "<pre>\n<code>\n {hp='+5' action={destroy_inventory_item, inventory_id='1234'}}\n</code>\n</pre>\n", "senID": 4}], [{"text": ["Hmm.", "This is a thought experiment, I don't know of it being done:"], "childNum": 0, "tag": "p", "senID": 0, "childList": []}, {"text": ["You could use the compiler package to parse the script.", "You can then walk this tree, prefixing all identifiers - variables, method names e.t.c.", "(also has|get|setattr invocations and so on) - with a unique preamble so that they cannot possibly refer to your variables.", "You could also ensure that the compiler package itself was not invoked, and perhaps other blacklisted things such as opening files.", "You then emit the python code for this, and compiler.compile it."], "childNum": 8, "tag": "p", "senID": 1, "childList": [{"text": "compiler", "tag": "a", "pos": 0, "childList": [{"text": "compiler", "tag": "code"}], "childNum": 1, "href": "http://docs.python.org/library/compiler.html"}, {"text": "compiler", "childNum": 0, "tag": "code", "pos": 3, "childList": []}, {"text": "parse", "tag": "a", "pos": -1, "childList": [{"text": "parse", "tag": "code"}], "childNum": 1, "href": "http://docs.python.org/library/compiler.html#compiler.parse"}, {"text": "parse", "childNum": 0, "tag": "code", "pos": -1, "childList": []}, {"text": "has|get|setattr", "childNum": 0, "tag": "code", "pos": -1, "childList": []}, {"text": "compiler", "childNum": 0, "tag": "code", "pos": 4, "childList": []}, {"href": "http://docs.python.org/library/compiler.html#compiler.compile", "text": "compiler.compile", "childNum": 1, "tag": "a", "childList": [{"text": "compiler.compile", "tag": "code"}]}, {"text": "compiler.compile", "childNum": 0, "tag": "code", "childList": []}]}, {"text": ["The docs note that the compiler package is not in Python 3.0, but does not mention what the 3.0 alternative is."], "childNum": 1, "tag": "p", "senID": 2, "childList": [{"text": "compiler", "childNum": 0, "tag": "code", "pos": 0, "childList": []}]}, {"text": ["In general, this is parallel to how forum software and such try to whitelist 'safe' Javascript or HTML e.t.c.", "And they historically have a bad record of stomping all the escapes.", "But you might have more luck with Python :)"], "childNum": 0, "tag": "p", "senID": 3, "childList": []}], [{"text": ["You'll probably be interested in the Python language services section of the libref for writing your own parser."], "childNum": 1, "tag": "p", "senID": 0, "childList": [{"text": "Python language services", "tag": "a", "pos": 0, "childList": [], "childNum": 0, "href": "http://docs.python.org/library/language.html"}]}], [{"text": ["I think your best bet is going to be a combination of the replies thus far."], "childNum": 0, "tag": "p", "senID": 0, "childList": []}, {"text": ["You'll want to parse and sanitise the input - removing any import statements for example."], "childNum": 0, "tag": "p", "senID": 1, "childList": []}, {"text": ["You can then use Messa's exec sample (or something similar) to allow the code execution against only the builtin variables of your choosing - most likely some sort of API defined by yourself that provides the programmer access to the functionality you deem relevant."], "childNum": 1, "tag": "p", "senID": 2, "childList": [{"text": "exec", "tag": "a", "pos": 0, "childList": [], "childNum": 0, "href": "http://docs.python.org/reference/simple_stmts.html#grammar-token-exec_stmt"}]}], [{"text": ["You'll find some ideas in this wiki page, but it does not look like it can be done easily."], "childNum": 1, "tag": "p", "senID": 0, "childList": [{"text": "this wiki page", "tag": "a", "pos": 0, "childList": [], "childNum": 0, "href": "http://wiki.python.org/moin/How%20can%20I%20run%20an%20untrusted%20Python%20script%20safely%20%28i.e.%20Sandbox%29"}]}]]