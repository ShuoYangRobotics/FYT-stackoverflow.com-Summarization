[[{"text": ["I am currently deleting the entities by their key, and it seems to be faster."], "childNum": 0, "tag": "p", "senID": 0, "childList": []}, {"code": "<pre>\n<code>\n from google.appengine.ext import db\n\nclass bulkdelete(webapp.RequestHandler):\n    def get(self):\n        self.response.headers['Content-Type'] = 'text/plain'\n        try:\n            while True:\n                q = db.GqlQuery(\"SELECT __key__ FROM MyModel\")\n                assert q.count()\n                db.delete(q.fetch(200))\n                time.sleep(0.5)\n        except Exception, e:\n            self.response.out.write(repr(e)+'\\n')\n            pass\n</code>\n</pre>\n", "senID": 1}, {"text": ["from the terminal, I run curl -N http://..."], "childNum": 0, "tag": "p", "senID": 2, "childList": []}], [{"text": ["If I were a paranoid person, I would say Google App Engine (GAE) has not made it easy for us to remove data if we want to.", "I am going to skip discussion on index sizes and how they translate a 6 GB of data to 35 GB of storage (being billed for).", "That's another story, but they do have ways to work around that - limit number of properties to create index on (automatically generated indexes) et cetera."], "childNum": 0, "tag": "p", "senID": 0, "childList": []}, {"text": ["The reason I decided to write this post is that I need to \"nuke\" all my Kinds in a sandbox.", "I read about it and finally came up with this code:"], "childNum": 0, "tag": "p", "senID": 1, "childList": []}, {"code": "<pre>\n<code>\n package com.intillium.formshnuker;\n\nimport java.io.IOException;\nimport java.util.ArrayList;\n\nimport javax.servlet.http.HttpServlet;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\n\nimport com.google.appengine.api.datastore.Key;\nimport com.google.appengine.api.datastore.Query;\nimport com.google.appengine.api.datastore.Entity;\nimport com.google.appengine.api.datastore.FetchOptions;\nimport com.google.appengine.api.datastore.DatastoreService;\nimport com.google.appengine.api.datastore.DatastoreServiceFactory;\n\nimport com.google.appengine.api.labs.taskqueue.QueueFactory;\nimport com.google.appengine.api.labs.taskqueue.TaskOptions.Method;\n\nimport static com.google.appengine.api.labs.taskqueue.TaskOptions.Builder.url;\n\n@SuppressWarnings(\"serial\")\npublic class FormsnukerServlet extends HttpServlet {\n\n public void doGet(final HttpServletRequest request, final HttpServletResponse response) throws IOException {\n\n  response.setContentType(\"text/plain\");\n\n  final String kind = request.getParameter(\"kind\");\n  final String passcode = request.getParameter(\"passcode\");\n\n  if (kind == null) {\n   throw new NullPointerException();\n  }\n\n  if (passcode == null) {\n   throw new NullPointerException();\n  }\n\n  if (!passcode.equals(\"LONGSECRETCODE\")) {\n   response.getWriter().println(\"BAD PASSCODE!\");\n   return;\n  }\n\n  System.err.println(\"*** deleting entities form \" + kind);\n\n  final long start = System.currentTimeMillis();\n\n  int deleted_count = 0;\n  boolean is_finished = false;\n\n  final DatastoreService dss = DatastoreServiceFactory.getDatastoreService();\n\n  while (System.currentTimeMillis() - start &lt; 16384) {\n\n   final Query query = new Query(kind);\n\n   query.setKeysOnly();\n\n   final ArrayList&lt;Key&gt; keys = new ArrayList&lt;Key&gt;();\n\n   for (final Entity entity: dss.prepare(query).asIterable(FetchOptions.Builder.withLimit(128))) {\n    keys.add(entity.getKey());\n   }\n\n   keys.trimToSize();\n\n   if (keys.size() == 0) {\n    is_finished = true;\n    break;\n   }\n\n   while (System.currentTimeMillis() - start &lt; 16384) {\n\n    try {\n\n     dss.delete(keys);\n\n     deleted_count += keys.size();\n\n     break;\n\n    } catch (Throwable ignore) {\n\n     continue;\n\n    }\n\n   }\n\n  }\n\n  System.err.println(\"*** deleted \" + deleted_count + \" entities form \" + kind);\n\n  if (is_finished) {\n\n   System.err.println(\"*** deletion job for \" + kind + \" is completed.\");\n\n  } else {\n\n   final int taskcount;\n\n   final String tcs = request.getParameter(\"taskcount\");\n\n   if (tcs == null) {\n    taskcount = 0;\n   } else {\n    taskcount = Integer.parseInt(tcs) + 1;\n   }\n\n   QueueFactory.getDefaultQueue().add(\n    url(\"/formsnuker?kind=\" + kind + \"&amp;passcode=LONGSECRETCODE&amp;taskcount=\" + taskcount).method(Method.GET));\n\n   System.err.println(\"*** deletion task # \" + taskcount + \" for \" + kind + \" is queued.\");\n\n  }\n\n  response.getWriter().println(\"OK\");\n\n }\n\n}\n</code>\n</pre>\n", "senID": 2}, {"text": ["I have over 6 million records.", "That's a lot.", "I have no idea what the cost will be to delete the records (maybe more economical not to delete them).", "Another alternative would be to request a deletion for the entire application (sandbox).", "But that's not realistic in most cases."], "childNum": 0, "tag": "p", "senID": 3, "childList": []}, {"text": ["I decided to go with smaller groups of records (in easy query).", "I know I could go for 500 entities, but then I started receiving very high rates of failure (re delete function)."], "childNum": 0, "tag": "p", "senID": 4, "childList": []}, {"text": ["My request from GAE team: please add a feature to delete all entities of a kind in a single transaction."], "childNum": 2, "tag": "p", "senID": 5, "childList": [{"text": "My request from GAE team: please add a feature to delete all entities of a kind in a single transaction.", "childNum": 1, "tag": "strong", "pos": 0, "childList": [{"text": "My request from GAE team: please add a feature to delete all entities of a kind in a single transaction.", "tag": "em"}]}, {"text": "My request from GAE team: please add a feature to delete all entities of a kind in a single transaction.", "childNum": 0, "tag": "em", "childList": []}]}], [{"text": ["Try using App Engine Console then you dont even have to deploy any special code"], "childNum": 1, "tag": "p", "senID": 0, "childList": [{"text": "App Engine Console", "tag": "a", "pos": 0, "childList": [], "childNum": 0, "href": "http://con.appspot.com/console/help/integration"}]}], [{"text": ["The fastest and efficient way to handle bulk delete on Datastore is by using the new mapper API announced on the latest Google I/O."], "childNum": 2, "tag": "p", "senID": 0, "childList": [{"text": "mapper API", "tag": "a", "pos": 0, "childList": [], "childNum": 0, "href": "http://code.google.com/p/appengine-mapreduce/"}, {"href": "http://code.google.com/events/io/2010/", "text": "Google I/O", "childNum": 0, "tag": "a", "childList": []}]}, {"text": ["If your language of choice is Python, you just have to register your mapper in a mapreduce.yaml file  and define a function like this:"], "childNum": 2, "tag": "p", "senID": 1, "childList": [{"text": "Python", "tag": "a", "pos": 0, "childList": [], "childNum": 0, "href": "http://code.google.com/p/appengine-mapreduce/wiki/GettingStartedInPython"}, {"text": "mapreduce.yaml", "childNum": 0, "tag": "em", "childList": []}]}, {"code": "<pre>\n<code>\n from mapreduce import operation as op\ndef process(entity):\n yield op.db.Delete(entity)\n</code>\n</pre>\n", "senID": 2}, {"text": ["On Java you should have a look to this article that suggests a function like this:"], "childNum": 2, "tag": "p", "senID": 3, "childList": [{"text": "Java", "tag": "a", "pos": 0, "childList": [], "childNum": 0, "href": "http://code.google.com/p/appengine-mapreduce/wiki/GettingStartedInJava"}, {"href": "http://ikaisays.com/2010/07/09/using-the-java-mapper-framework-for-app-engine/", "text": "this article", "childNum": 0, "tag": "a", "childList": []}]}, {"code": "<pre>\n<code>\n @Override\npublic void map(Key key, Entity value, Context context) {\n    log.info(\"Adding key to deletion pool: \" + key);\n    DatastoreMutationPool mutationPool = this.getAppEngineContext(context)\n            .getMutationPool();\n    mutationPool.delete(value.getKey());\n}\n</code>\n</pre>\n", "senID": 4}], [{"text": ["Presumably your hack was something like this:"], "childNum": 0, "tag": "p", "senID": 0, "childList": []}, {"code": "<pre>\n<code>\n q = db.GqlQuery(\"SELECT * FROM Message WHERE create_date &lt; :1\", earliest_date)\nresults = q.fetch(1000)\n\nwhile results:\n    db.delete(results)\n    results = fetch(1000, len(results))\n</code>\n</pre>\n", "senID": 1}, {"text": ["As you say, if there's sufficient data, you're going to hit the request timeout before it gets through all the records.", "You'd have to re-invoke this request multiple times from outside to ensure all the data was erased; easy enough to do, but hardly ideal."], "childNum": 0, "tag": "p", "senID": 2, "childList": []}, {"text": ["The admin console doesn't seem to offer any help, as (from my own experience with it), it seems to only allow entities of a given type to be listed and then deleted on a page-by-page basis."], "childNum": 0, "tag": "p", "senID": 3, "childList": []}, {"text": ["When testing, I've had to purge my database on startup to get rid of existing data."], "childNum": 0, "tag": "p", "senID": 4, "childList": []}, {"text": ["I would infer from this that Google's operates on the principle that disk is cheap, and so data is typically orphaned (indexes to redundant data replaced), rather than deleted.", "Given there's a fixed amount of data available to each app at the moment (0.5 GB), that's not much help for non-Google App Engine users."], "childNum": 0, "tag": "p", "senID": 5, "childList": []}], [{"text": ["I've tried db.delete(results) and App Engine Console, and none of them seems to be working for me.", "Manually removing entries from Data Viewer (increased limit up to 200) didn't work either since I have uploaded more than 10000 entries.", "I ended writing this script "], "childNum": 0, "tag": "p", "senID": 0, "childList": []}, {"code": "<pre>\n<code>\n from google.appengine.ext import db\nfrom google.appengine.ext import webapp\nfrom google.appengine.ext.webapp.util import run_wsgi_app\nimport wsgiref.handlers\nfrom mainPage import YourData #replace this with your data\nclass CleanTable(webapp.RequestHandler):\n    def get(self, param):\n        txt = self.request.get('table')\n        q = db.GqlQuery(\"SELECT * FROM \"+txt)\n        results = q.fetch(10)\n        self.response.headers['Content-Type'] = 'text/plain'\n        #replace yourapp and YouData your app info below.\n        self.response.out.write(\"\"\"\n          &lt;html&gt;\n          &lt;meta HTTP-EQUIV=\"REFRESH\" content=\"5; url=http://yourapp.appspot.com/cleanTable?table=YourData\"&gt;\n            &lt;body&gt;\"\"\")\n\n        try:\n            for i in range(10):\n                db.delete(results)\n                results = q.fetch(10, len(results))\n                self.response.out.write(\"&lt;p&gt;10 removed&lt;/p&gt;\")\n                self.response.out.write(\"\"\"\n                &lt;/body&gt;\n              &lt;/html&gt;\"\"\")\n\n        except Exception, ints:\n            self.response.out.write(str(inst))\n\ndef main():\n  application = webapp.WSGIApplication([\n    ('/cleanTable(.*)', CleanTable),\n  ])\n\n  wsgiref.handlers.CGIHandler().run(application)\n</code>\n</pre>\n", "senID": 1}, {"text": ["The trick was to include redirect in html instead of using self.redirect.", "I'm ready to wait overnight to get rid of all the data in my table.", "Hopefully, GAE team will make it easier to drop tables in the future.  "], "childNum": 0, "tag": "p", "senID": 2, "childList": []}], [{"text": ["Unfortunately, there's no way to easily do a bulk delete.", "Your best bet is to write a script that deletes a reasonable number of entries per invocation, and then call it repeatedly - for example, by having your delete script return a 302 redirect whenever there's more data to delete, then fetching it with \"wget --max-redirect=10000\" (or some other large number)."], "childNum": 0, "tag": "p", "senID": 0, "childList": []}], [{"text": ["One tip.", "I suggest you get to know the remote_api for these types of uses (bulk deleting, modifying, etc.).", "But, even with the remote api, batch size can be limited to a few hundred at a time."], "childNum": 1, "tag": "p", "senID": 0, "childList": [{"text": "remote_api", "tag": "a", "pos": 1, "childList": [], "childNum": 0, "href": "http://code.google.com/appengine/articles/remote%5Fapi.html"}]}], [{"text": ["The official answer from Google is that you have to delete in chunks spread over multiple requests.", "You can use AJAX, meta refresh, or request your URL from a script until there are no entities left."], "childNum": 2, "tag": "p", "senID": 0, "childList": [{"text": "official answer", "tag": "a", "pos": 0, "childList": [], "childNum": 0, "href": "http://groups.google.com/group/google-appengine/browse_thread/thread/ec0800a3ca92fe69#"}, {"text": "meta refresh", "tag": "a", "pos": 1, "childList": [], "childNum": 0, "href": "http://en.wikipedia.org/wiki/Meta_refresh"}]}], [{"text": ["You can now use the Datastore Admin for that: http://code.google.com/appengine/docs/adminconsole/datastoreadmin.html"], "childNum": 1, "tag": "p", "senID": 0, "childList": [{"text": "http://code.google.com/appengine/docs/adminconsole/datastoreadmin.html", "tag": "a", "pos": 0, "childList": [], "childNum": 0, "href": "http://code.google.com/appengine/docs/adminconsole/datastoreadmin.html"}]}], [{"text": ["If you are using Java/JPA you can do something like this:"], "childNum": 0, "tag": "p", "senID": 0, "childList": []}, {"code": "<pre>\n<code>\n em = EntityManagerFactoryUtils.getTransactionalEntityManager(entityManagerFactory)\n    Query q = em.createQuery(\"delete from Table t\");\n    int number = q.executeUpdate();\n</code>\n</pre>\n", "senID": 1}, {"text": ["Java/JDO info can be found here: http://code.google.com/appengine/docs/java/datastore/queriesandindexes.html#Delete_By_Query"], "childNum": 1, "tag": "p", "senID": 2, "childList": [{"text": "http://code.google.com/appengine/docs/java/datastore/queriesandindexes.html#Delete_By_Query", "tag": "a", "pos": 0, "childList": [], "childNum": 0, "href": "http://code.google.com/appengine/docs/java/datastore/queriesandindexes.html#Delete_By_Query"}]}], [{"text": ["You can use the task queues to delete chunks of say 100 objects.", "Deleting objects in GAE shows how limited the Admin capabilities are in GAE.", "You have to work with batches on 1000 entities or less.", "You can use the bulkloader tool that works with csv's but the documentation does not cover java.", "I am using GAE Java and my strategy for deletions involves having 2 servlets, one for doing the actually delete and another to load the task queues.", "When i want to do a delete, I run the queue loading servlet, it loads the queues and then GAE goes to work executing all the tasks in the queue."], "childNum": 0, "tag": "p", "senID": 0, "childList": []}, {"text": ["How to do it:\nCreate a servlet that deletes a small number of objects.", "Add the servlet to your task queues.", "Go home or work on something else ;)\nCheck the datastore every so often ..."], "childNum": 0, "tag": "p", "senID": 1, "childList": []}, {"text": ["I have a datastore with about 5000 objects that i purge every week and it takes about 6 hours to clean out, so i run the task on Friday night.", "I use the same technique to bulk load my data which happens to be about 5000 objects, with about a dozen properties. "], "childNum": 0, "tag": "p", "senID": 2, "childList": []}], [{"text": ["With django, setup url: "], "childNum": 0, "tag": "p", "senID": 0, "childList": []}, {"code": "<pre>\n<code>\n url(r'^Model/bdelete/$', v.bulk_delete_models, {'model':'ModelKind'}),\n</code>\n</pre>\n", "senID": 1}, {"text": ["Setup view"], "childNum": 0, "tag": "p", "senID": 2, "childList": []}, {"code": "<pre>\n<code>\n def bulk_delete_models(request, model):\n    import time\n    limit = request.GET['limit'] or 200\n    start = time.clock()\n    set = db.GqlQuery(\"SELECT __key__ FROM %s\" % model).fetch(int(limit))\n    count = len(set)\n    db.delete(set)\n    return HttpResponse(\"Deleted %s %s in %s\" % (count,model,(time.clock() - start)))\n</code>\n</pre>\n", "senID": 3}, {"text": ["Then run in powershell:"], "childNum": 0, "tag": "p", "senID": 4, "childList": []}, {"code": "<pre>\n<code>\n $client = new-object System.Net.WebClient\n$client.DownloadString(\"http://your-app.com/Model/bdelete/?limit=400\")\n</code>\n</pre>\n", "senID": 5}], [{"text": ["This worked for me:"], "childNum": 0, "tag": "p", "senID": 0, "childList": []}, {"code": "<pre>\n<code>\n class ClearHandler(webapp.RequestHandler):  \n    def get(self):  \n        self.response.headers['Content-Type'] = 'text/plain'  \n        q = db.GqlQuery(\"SELECT * FROM SomeModel\")  \n        self.response.out.write(\"deleting...\")  \n        db.delete(q)\n</code>\n</pre>\n", "senID": 1}], [{"text": ["Thank you all guys, I got what I need.", ":D\nThis may be useful if you have lots db models to delete, you can dispatch it in your terminal.", "And also, you can manage the delete list in DB_MODEL_LIST yourself.", "Delete DB_1:"], "childNum": 2, "tag": "p", "senID": 0, "childList": [{"text": "", "childNum": 0, "tag": "br", "pos": 0, "childList": []}, {"text": "", "childNum": 0, "tag": "br", "pos": 1, "childList": []}]}, {"code": "<pre>\n<code>\n python bulkdel.py 10 DB_1\n</code>\n</pre>\n", "senID": 1}, {"text": ["Delete All DB:"], "childNum": 0, "tag": "p", "senID": 2, "childList": []}, {"code": "<pre>\n<code>\n python bulkdel.py 11\n</code>\n</pre>\n", "senID": 3}, {"text": ["Here is the bulkdel.py file:"], "childNum": 0, "tag": "p", "senID": 4, "childList": []}, {"code": "<pre>\n<code>\n import sys, os\n\nURL = 'http://localhost:8080'\nDB_MODEL_LIST = ['DB_1', 'DB_2', 'DB_3']\n\n# Delete Model\nif sys.argv[1] == '10' :\n    command = 'curl %s/clear_db?model=%s' % ( URL, sys.argv[2] )\n    os.system( command )\n\n# Delete All DB Models\nif sys.argv[1] == '11' :\n    for model in DB_MODEL_LIST :\n        command = 'curl %s/clear_db?model=%s' % ( URL, model )\n        os.system( command )\n</code>\n</pre>\n", "senID": 5}, {"text": ["And here is the modified version of alexandre fiori's code."], "childNum": 0, "tag": "p", "senID": 6, "childList": []}, {"code": "<pre>\n<code>\n from google.appengine.ext import db\nclass DBDelete( webapp.RequestHandler ):\n    def get( self ):\n        self.response.headers['Content-Type'] = 'text/plain'\n        db_model = self.request.get('model')\n        sql = 'SELECT __key__ FROM %s' % db_model\n\n        try:\n            while True:\n                q = db.GqlQuery( sql )\n                assert q.count()\n                db.delete( q.fetch(200) )\n                time.sleep(0.5)\n        except Exception, e:\n            self.response.out.write( repr(e)+'\\n' )\n            pass\n</code>\n</pre>\n", "senID": 7}, {"text": ["And of course, you should map the link to model in a file(like main.py in GAE), ;)\nIn case some guys like me need it in detail, here is part of main.py:"], "childNum": 1, "tag": "p", "senID": 8, "childList": [{"text": "", "childNum": 0, "tag": "br", "pos": 0, "childList": []}]}, {"code": "<pre>\n<code>\n from google.appengine.ext import webapp\nimport utility # DBDelete was defined in utility.py\napplication = webapp.WSGIApplication([('/clear_db',utility.DBDelete ),('/',views.MainPage )],debug = True)\n</code>\n</pre>\n", "senID": 9}]]